<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Authentication and Authorization with Verifiable Credentials</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Opengraph Facebook Meta Tags -->
    <meta property="og:title" content="Authentication and Authorization with Verifiable Credentials">
    <meta property="og:type" content="website">
    <meta property="og:description" content="Authentication and Authorization with Verifiable Credentials">
    <meta property="og:site_name" content="Authn with Verifiable Credentials">
    <meta property="og:url" content="https://alastria.github.io/did-method-elsi/authzn.html">

    <script src="https://www.w3.org/Tools/respec/respec-w3c" async="" class="remove"></script>
    <script class="remove">
        var respecConfig = {
            latestVersion: "https://alastria.github.io/did-method-elsi/authzn.html",
            edDraftURI: "https://alastria.github.io/did-method-elsi/authzn.html",
            github: "https://github.com/alastria/did-method-elsi/blob/main/authzn.html",
            editors: [
                {
                    company: "JesusRuiz",
                    companyURL: "https://hesusruiz.github.io/hesusruiz",
                    email: "hesusruiz@gmail.com",
                    name: "Jesus Ruiz",
                },
            ],
            authors: [
                {
                    company: "JesusRuiz",
                    companyURL: "https://hesusruiz.github.io/hesusruiz",
                    email: "hesusruiz@gmail.com",
                    name: "Jesus Ruiz",
                },
                {
                    company: "nicos AG",
                    companyURL: "https://www.nicos-ag.com/",
                    email: "jlangkau@nicos-ag.com",
                    name: "Jörg Langkau ",
                },
            ],
            localBiblio: {
                "DEP-DSS": {
                        date: "2019-10",
                        href: "https://ec.europa.eu/digital-building-blocks/wikis/display/DIGITAL/Qualified+electronic+signature+-+QES+validation+algorithm",
                        publisher: "European Commission",
                        title: "Algorithm for Validation of qualified and advanced signatures and seals",
                },
                "DID-DNS": {
                        href: "https://tools.ietf.org/html/draft-mayrhofer-did-dns-01",
                        publisher: "IETF",
                        status: "Internet Draft",
                        title: "The Decentralized Identifier (DID) in the DNS",
                },
                "DID-ELSI": {
                        date: "04 June 2023",
                        href: "https://alastria.github.io/did-method-elsi/",
                        title: "DID ETSI Legal person Semantic Identifier Method Specification (did:elsi)",
                },
                "DID-ONBOARDING": {
                        date: "04 June 2023",
                        href: "https://alastria.github.io/did-method-elsi/onboarding.html",
                        title: "Onboarding example with LEARCredential using did:elsi",
                },
                "DID-PRIMER": {
                        href: "https://github.com/WebOfTrustInfo/rebooting-the-web-of-trust-fall2017/blob/master/topics-and-advance-readings/did-primer.md",
                        publisher: "Rebooting the Web of Trust 2017",
                        title: "DID Primer",
                },
                "DIF.PresentationExchange": {
                        href: "https://identity.foundation/presentation-exchange/spec/v2.0.0/",
                        title: "Presentation Exchange 2.0.0",
                },
                "ENISA-QES": {
                        date: "December 2016",
                        href: "https://www.enisa.europa.eu/publications/security-guidelines-on-the-appropriate-use-of-qualified-electronic-signatures",
                        title: "Security guidelines on the appropriate use of qualified electronic signatures",
                },
                "ENISA-QSEAL": {
                        date: "June 2017",
                        href: "https://www.enisa.europa.eu/publications/security-guidelines-on-the-appropriate-use-of-qualified-electronic-seals",
                        title: "Security guidelines on the appropriate use of qualified electronic seals",
                },
                "ETSI-CERTOVERVIEW": {
                        date: "2020-07",
                        href: "https://www.etsi.org/deliver/etsi_en/319400_319499/31941201/01.04.02_20/en_31941201v010402a.pdf",
                        publisher: "ETSI",
                        title: "ETSI EN 319 412-1 V1.4.2 (2020-07) - Electronic Signatures and Infrastructures (ESI); Certificate Profiles; Part 1: Overview and common data structures",
                },
                "ETSI-JADES": {
                        date: "2021-03",
                        href: "https://www.etsi.org/deliver/etsi_ts/119100_119199/11918201/01.01.01_60/ts_11918201v010101p.pdf",
                        publisher: "ETSI",
                        title: "ETSI TS 119 182-1 V1.1.1 (2021-03) - Electronic Signatures and Infrastructures (ESI); JAdES digital signatures; Part 1: Building blocks and JAdES baseline signatures",
                },
                "ETSI-LEGALPERSON": {
                        date: "2020-07",
                        href: "https://www.etsi.org/deliver/etsi_en/319400_319499/31941203/01.02.01_60/en_31941203v010201p.pdf",
                        publisher: "ETSI",
                        title: "ETSI EN 319 412-3 V1.2.1 (2020-07) - Electronic Signatures and Infrastructures (ESI); Certificate Profiles; Part 3: Certificate profile for certificates issued to legal persons",
                },
                "NIST-AUTH": {
                        date: "October 2016",
                        href: "https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-178.pdf",
                        title: "NIST Special Publication 800-178: A Comparison of Attribute Based Access Control (ABAC) Standards for Data Service Applications",
                },
                "OWASP-TRANSPORT": {
                        href: "https://www.owasp.org/index.php/Transport_Layer_Protection_Cheat_Sheet",
                        title: "Transport Layer Protection Cheatsheet",
                },
                "OpenID.Core": {
                        date: "8 November 2014",
                        href: "http://openid.net/specs/openid-connect-core-1_0.html",
                        title: "OpenID Connect Core 1.0 incorporating errata set 1",
                },
                "OpenID.SIOP2": {
                        date: "28 January 2022",
                        href: "https://openid.bitbucket.io/connect/openid-connect-self-issued-v2-1_0.html",
                        title: "Self-Issued OpenID Provider v2",
                },
                "OpenID.VCI": {
                        date: "3 February 2023",
                        href: "https://openid.net/specs/openid-4-verifiable-credential-issuance-1_0.html",
                        title: "OpenID for Verifiable Credential Issuance",
                },
                "OpenID.VP": {
                        date: "21 April 2023",
                        href: "https://openid.net/specs/openid-4-verifiable-presentations-1_0.html",
                        title: "OpenID for Verifiable Presentations",
                },
                "RFC6749": {
                        href: "https://www.rfc-editor.org/rfc/rfc6749.html",
                        title: "The OAuth 2.0 Authorization Framework",
                },
                "RFC7515": {
                        href: "https://www.rfc-editor.org/rfc/rfc7515",
                        title: "JSON Web Signature (JWS)",
                },
                "RFC7519": {
                        href: "https://www.rfc-editor.org/rfc/rfc7519",
                        title: "JSON Web Token (JWT)",
                },
                "RFC8414": {
                        href: "https://www.rfc-editor.org/rfc/rfc8414",
                        title: "OAuth 2.0 Authorization Server Metadata",
                },
                "RFC8725": {
                        href: "https://www.rfc-editor.org/rfc/rfc8725",
                        title: "JSON Web Token Best Current Practices",
                },
            },
        };
    </script>
    <link rel="stylesheet" href="./assets/templates/respec/additional.css">
</head>

<body>
    <p class="copyright">
        Copyright © 2023 the document editors/authors. Text is available under the <a rel="license" href="https://creativecommons.org/licenses/by/4.0/legalcode"> Creative Commons Attribution 4.0 International Public License</a>
    </p>


<section id='abstract'>
    <p>We describe here a mechanism to use Verifiable Credentials to perform Authentication and Access Control leveraging the eIDAS trust framework and using advanced or qualified signatures and seals to provide a high level of legal certainty and specially enjoying the presumption of npn-repudiation provided by those eIDAS signatures.
    </p>
    <p>This document describes:
    </p>
    <ul>
        <li>How an organisation can issue Verifiable Credentials to its employees enabling them to perform some specific processes in other organisations "on-behalf-of" the employer, in a way which is compatible with eIDAS and so it provides a legal certainty and non-repudiation levels equivalent to signed documents typically used for those tasks.
        </li>
        <li>How other organisations can accept those Verifiable Credentials to perform authentication and access control, leveraging the eIDAS legal framework to obtain the same levels of legal certainty and non-repudiation as when using other traditional forms of documentation.
        </li>
    </ul>
</section>
<section id='conformance'>
</section>
<section><h2>Authentication and Authorization with Verifiable Credentials</h2>

    <section><h2>Introduction</h2>

        <p>We describe here a mechanism to use Verifiable Credentials to perform Authentication and Access Control leveraging the eIDAS trust framework and using advanced or qualified signatures and seals to provide a high level of legal certainty and specially enjoying the presumption of non-repudiation provided by those eIDAS signatures.
        </p>
        <table style='width:100%;'><tr><td class='xwarnt'><aside class='xwarna'>

            <p>We focus here on <code>legal persons</code>. It is out of scope the identification and authentication of <code>natural persons</code> (except when acting as representatives of the legal person, see below). Whenever eIDAS2 and the EUDIW (European Digital Identity Wallet) are ready, we will support that mechanism for identification and access control.
            </p>
        </aside></td></tr></table>
        <p>We support identification and access control of <code>legal persons</code> when they want to access products and services provided by other <code>legal entities</code>.
        </p>
        <p>To do so, we define specific types of Verifiable Credentials with a format and a mechanism which specify: a way to sign the credentials; a way to bind the identity of the holder of a credential to the identity of the subject inside the credential; and a way to embed authorisation information in the credential with the powers that the legal entity has delegated to the subject inside the credential.
        </p>
        <p>This document describes:
        </p>
        <ul>
            <li>How an organisation can issue Verifiable Credentials to other entities enabling them to perform some specific processes in other organisations "on-behalf-of" the issuer, in a way which is compatible with eIDAS and so it provides a legal certainty and non-repudiation levels equivalent to signed documents typically used for those tasks.
            </li>
            <li>How other organisations can accept those Verifiable Credentials to perform authentication and access control, leveraging the eIDAS legal framework to obtain the same levels of legal certainty and non-repudiation as when using other traditional forms of documentation.
            </li>
        </ul>
        <p>The mechanisms described here can be used to generate credentials to employees, contractors, customers and even to machines and devices acting on behalf of an organisation. The schema is identical, except the issuance process is probably a little bit different and the roles and duties embedded in the credentials have different legal implications (but always in line with the legal framework, for example with the Consumer Protection Directive).
        </p>
        <section><h2>Signature of the Verifiable Credentials</h2>

            <p>The mechanism for signing the Verifiable Credentials:
            </p>
            <p><b>Provides high assurance of the identity of the creator of the credential.</b>
                <p>We use <b>qualified certificates for electronic seals</b> provided by <b>eIDAS Qualified Trust Services Providers</b> (QTSPs) to seal credentials with <b>advanced electronic seals</b> (AdESeal) or <b>qualified electronic seals</b> (QESeal) with the <b>JSON Advanced Electronic Signature</b> format (JAdES).
                </p>
                <p>They provide <b>high assurance of the identity of the creator of the seal</b>. For example, it will be difficult for a malicious user to get a qualified seal certificate in the name of a company, because the QTSP will be responsible to check that such seal is issued to the persons representing the company and not to unauthorised persons.
                </p>
            </p>
            <p><b>Enables authorised representative of the legal person to act on behalf of the legal person.</b>
                <p>We also can use <b>qualified certificates for electronic signatures</b> issued to <b>authorised representatives of the legal person</b> by a QTSP, to sign credentials with <b>advanced electronic signatures</b> (AdES) or <b>qualified electronic signatures</b> (QES) with the <b>JSON Advanced Electronic Signature</b> format (JAdES).
                </p>
                <p>This provides high legal predictability, including for the qualified electronic signature the benefits from the <b>legal equivalence to handwritten signatures</b>.
                </p>
                <p>As stated by the eIDAS Regulation, when a transaction requires a qualified electronic seal from a legal person, a qualified electronic signature from the authorised representative of the legal person should be equally acceptable.
                </p>
                <p>It is possible to certify elements that are bound to the signatory such as a title (e.g. Director), a link with its employer, etc. Because the QTSP is trusted for verifying the information it certifies, the Relying Party can get a high level of confidence in such information conveyed with the signature through the signatory's certificate.
                </p>
                <p>This provides high legal predictability, including for the qualified electronic signature the benefits from the <b>legal equivalence to handwritten signatures</b>.
                </p>
                <p>In this way, the Relying Party receiving Verifiable Credentials can have the same legal certainty than with any other document in other formats (e.g. PDF) signed with AdES or QES signatures or with handwritten signatures (in the case of QES).
                </p>
            </p>
            <p><b>Provides high level of legal certainty and interoperability.</b>
                <p>Any basic signature benefits from the non-discrimination rule, which means that a Court in an EU Member State cannot reject it automatically as being invalid simply because they are in electronic form.
                </p>
                <p>However, their dependability is lower than that of an AdES or QES because the signatory may be required to prove the security of the technology being used if the validity of the signature is disputed before a court. This requires significant costs and efforts that could be avoided with relative ease by opting for the more established and standardised advanced and qualified signature solutions. It may also be the case that the relying parties have no applications or tools to validate such signature, when not based on standards; in such a scenario, the signature may be legally valid and technologically robust, but of limited use ([[ENISA-QES]] and [[ENISA-QSEAL]]).
                </p>
                <p>For these interoperability reasons, QES that are based on recognised EU standards are preferable unless the parties operate purely in a local context where the acceptance and usability of the chosen signature solution is sufficiently certain.
                </p>
                <p>Beyond the technical interoperability, the eIDAS Regulation also ensures the international recognition of electronic signatures.
                </p>
            </p>
        </section>
        <section><h2>Authentication requires a VerifiableID</h2>

            <p>Not all types of Verifiable Credentials can be used as a mechanism for online authentication, because the Relying Party (the entity receiving the Verifiable Credential in an authentication process) needs to bind the identity of the user sending the credential to the claims attested about the subject inside the credential.
            </p>
            <p>For the purpose of this discussion we use a diagram derived from the taxonomy <a href="https://ec.europa.eu/digital-building-blocks/wikis/display/EBSIDOC/Data+Models+and+Schemas">defined in EBSI</a>:
            </p>
            <figure><img src='builtassets/plantuml_78bc41a433a2657fc60dd292cca51c5d.png' alt=''>
            <figcaption>Types of credentials</figcaption></figure>

            <p>For example, in the case of a Diploma as a Verifiable Credential (a Verifiable Diploma), the credential is a Verifiable Attestation which indicates that the subject has certain skills or has achieved certain learning outcomes through formal or non-formal learning context. However, as in the case with normal Diplomas in paper of PDF format, this credential can be presented by anyone that holds the credential. In other words, the credential binds the identity of the subject with the claims inside the credential, but does not bind the identity of the holder of the credential with the identity of the subject of the credential, which requires a special mechanism in the issuance process.
            </p>
            <p>Most Verifiable Credentials will be issued as Verifiable Attestations, acting as efficient machine-processable and verifiable equivalent to their analog counterparts. Their purpose is to attest some attributes about the subject of the credential and not act as a mechanism for online authentication.
            </p>
            <p>Instead, <b>a <code>VerifiableID</code> is a special form of a Verifiable Credential that a natural or legal person can use in an electronic identification process as evidence of whom he/she/it is</b> (comparable with a passport, physical IDcard, driving licence, social security card, member-card…).
            </p>
            <p>VerifiableIDs can be of different types and be issued by different entities with different levels of assurance (in eIDAS terminology). They are issued with the purpose of serving as authentication mechanisms in online processes. In the near future, VerifiableIDs of the highest level of assurance (LoA High) will be issued to citizens and businesses by their governments under eIDAS2.
            </p>
            <p>We describe in this document a way to issue VerifiableID credentials and how a Relying Party can perform authentication by accepting that credential.
            </p>
        </section>
        <section><h2>Access Control requires a Verifiable Authorisation</h2>

            <p>Once the user is authenticated, the system should make a decision to grant or reject an access request to a protected resource from an already authenticated subject, based on what the subject is authorised to access.
            </p>
            <p>Let's take the example of when a Service Provider signs an agreement with a Service Consumer organisation (a legal person), and the Service Provider wants to allow access to some services to employees of the Consumer organisation under the conditions of the agreement.
            </p>
            <p>In most cases, granting access is not an all-or-nothing decision. In general, the agreement between the Service Provider and Service Consumer specifies that only a subset of the employees of the Consumer organisation can access the services, and even in that subset not all employees have the same powers when accessing the services. For example, some employees have access to the administration of the service, some can perform some create/update/delete operations in a subset of the services, and some employees can only have read access to a subset of the services.
            </p>
            <p>To allow for this granularity in an authentication and access control process, in general the entity willing to perform an action on a protected resource has to present (in a Verifiable Presentation) a VerifiableID and possibly one or more additional Verifiable Attestations.
            </p>
            <p>At least one of the credentials should include claims identifying the employee (or any other subject) and a formal description of the concrete powers that have been delegated by the legal representative of the organisation, enabling the determination by the Service Provider whether the user is entitled to access a service and the operations that the user can perform on that service.
            </p>
            <p>We define later a standard mechanism and format for a Verifiable Credential that enables this functionality in a simple, secure and with high degree of legal certainty compatible with eIDAS.
            </p>
            <p>Such a credential is called a Verifiable Authorization, represented in the figure above.
            </p>
        </section>
        <section><h2>Combining VerifiableID and Verifiable Authorisation in the LEARCredential</h2>

            <p>In many use cases, it is possible to simplify the authentication and access control by combining in a single credential both a VerifiableID (authentication) and a Verifiable Authorisation (for access control).
            </p>
            <p>The resulting credential is called LEARCredential and it is very useful when the holder/subject wants to use decentralised IAM mechanisms implemented by Relying Parties which are federated in a decentralised way using a common Trust Anchor Framework.
            </p>
            <p>The concept of LEARCredential is described in the diagram above.
            </p>
            <p>The appointed employee will perform the process by using a special type of Verifiable Credential called <code>LEARCredential</code> (from <b>L</b>egal <b>E</b>ntity <b>A</b>ppointed <b>R</b>epresentative).
            </p>
            <p>To achieve a high level of legal certainty under eIDAS, the LEARCredential is:
            </p>
            <ul>
                <li>signed or sealed with an eIDAS certificate which is either:
                    <div>
                    <ul>
                        <li>a <b>certificate for electronic seals</b> issued to a legal person by a Qualified Trust Service Provider, or
                        </li>
                        <li>a <b>certificate for electronic signatures</b>, issued to a <b>legal representative of the legal person</b> by a Qualified Trust Service Provider.
                        </li>
                    </ul>
                    </div>
                </li>
                <li>signed using the <b>JSON Advanced Electronic Signature</b> format described in [[[ETSI-JADES]]]
                </li>
            </ul>
            <p>The LEARCredential includes claims identifying the employee and a description of the concrete powers that have been delegated by the legal representative of the organisation.
            </p>
            <p>By signing/sealing the credential with an eIDAS certificate, the legal representative attests that the powers described in the credential have been delegated to the employee (maybe under some conditions, also described in the credential).
            </p>
            <p>In this way, the LEARCredential has the same legal status as any other document in other formats (e.g., PDF) signed in an eIDAS-compliant way, but with all the advantages provided by the Verifiable Credential format.
            </p>
            <p>In addition, the LEARCredential includes cryptographic material that allows the appointed employee to <b>use the credential as an online authentication mechanism</b> in a portal, by proving that the holder of the credential is the same person identified in the credential.
            </p>
            <p>Any Verifier that trusts the eIDAS Trust Framework will be able to verify that:
            </p>
            <ul>
                <li><b>The person presenting the LEARCredential is the same as the one identified in the credential</b>
                </li>
                <li><b>A legal representative of the organisation has attested that the person has the powers described in the credential</b>
                </li>
            </ul>
            <p>This enables the person presenting the LEARCredential to start the process and to provide any additional required documentation, preferably as additional Verifiable Credentials to enable automatic verification of compliance with the process requirements (including Gaia-X credentials issued by the Compliance Service of Gaia-X).
            </p>
            <p>Both types of eIDAS certificates mentioned above are an electronic attestation <b>that links electronic seal/signature validation data to a legal person and confirms the name of that person</b>. This way, the certificate, usually linked to the sealed/signed document, can be used to verify the identity of the creator of the seal/signature and whether the document has been sealed/signed using the corresponding private key.
            </p>
            <p>Before issuing a certificate like the above, the Qualified Trust Service Provider (QTSP) performs validations against <code>Authentic Sources</code> to authenticate the identity of the organisation:
            </p>
            <ul>
                <li>The data concerning the business name or corporate name of the organisation.
                </li>
                <li>The data relating to the constitution and legal status of the subscriber.
                </li>
                <li>The data concerning the extent and validity of the powers of representation of the applicant.
                </li>
                <li>The data concerning the tax identification code of the organisation or equivalent code used in the country to whose legislation the subscriber is subject.
                </li>
            </ul>
            <p>The person controlling the above certificates will appoint a legal entity representative (LEAR) by generating and signing a Verifiable Credential which:
            </p>
            <ul>
                <li>Includes identification data of an employee of the organisation
                </li>
                <li>Includes claims stating the delegation of specific powers to perform a set of specific processes on behalf of the organisation
                </li>
                <li>Includes a public key where the corresponding private key is controlled by the employee, enabling him to prove that he is the holder of the credential when it is being used in an authentication process like the ones used as examples in this document.
                </li>
            </ul>
            <p>The LEARCredential uses the <code>did:elsi</code> method for the identifiers of legal persons involved in the process, to facilitate the DID resolution and linkage with the eIDAS certificates. The <code>did:elsi</code> method is specified in [[[DID-ELSI]]].
            </p>
            <p>The high-level view of the process is described in the following diagram, when a COO (Chief Operating Officer) appoints an employee to perform some processes:
            </p>
            <figure><img src='builtassets/plantuml_53418b3092cb323db978af09dc064024.png' alt=''>
            <figcaption>High level view of issuance of LEARCredential</figcaption></figure>

        </section>
        <section><h2>The LEARCredential for some identification processes</h2>

            <p>But <b>any entity can issue VerifiableIDs</b>, though the acceptance by Relying Parties can not be ensured because it is the Relying Party the only one deciding if it trusts on the issuer and its process for generating the VerifiableID.
            </p>
            <p>DOME will make use of the future eIDAS2 VerifiableIDs when they are available and when they make sense in the context of DOME. But DOME defines some specific types of VerifiableIDs that are derived from eIDAS certificates for signatures/seals using the regulated standards for signatures, achieving a level of assurance that provides an acceptable level of legal certainty and reduced risk of repudiation.
            </p>
            <p>An example is the LEARCredential described in a section above, which has the same level of legal certainty as any document signed with the same certificates (like a contract or an invoice).
            </p>
            <p>Similarly, a Product provider (like GoodAir) who decides to use the DOME Trust and IAM framework or a compatible one for managing access to associated services by customers of their products will typically define specific types of VerifiableIDs if the standard ones in DOME or the existing and widely accepted ones are not suitable for the provider. In general, if a provider can use an existing and already used VerifiableID then it will facilitate potential customers access to its product because issuers of the VerifiableID do not have to modify or adapt their existing issuing processes.
            </p>
        </section>
    </section>
    <section><h2>The LEARCredential through an example</h2>

        <p>In this section we describe in detail the LEARCredential and for illustrative purpose we use example attributes from a fictitious ecosystem whose participants are described in Appendix <a href="#participants" class="xref">Example scenario: Participants in the ecosystem</a>.
        </p>
        <p>In this example the LEARCredential will be generated using the eIDAS certificate of the COO (Chief Operation Officer) of the organisation that will be issuing the credential.
        </p>
        <p>The credential will be generated with an application that the COO will use as Issuer of the LEARCredential and that allows the employee to receive the credential using his credential wallet, using [[OpenID.VCI]] to achieve compliance with the EUDI Wallet ARF.
        </p>
        <p>This application enables the COO to attest the information required to create the LEARCredential, specifying the employee information and the specific type of LEARCredential. In general, there may be different instances of LEARCredentials for different purposes. One employee can have more than one LEARCredential, each having a different delegation of powers for different environments.
        </p>
        <p>The specific detailed use case here is the issuance of a LEARCredential to an employee to enable that employee to perform the onboarding process in an ecosystem. But exactly the same process with different attested attributes can be used by any organisation to issue credentials that can be accepted by other organisations for authentication and access control to any protected resources that they manage.
        </p>
        <p>The essential components of a LEARCredential are the following:
        </p>
        <ul>
            <li><b>Claims identifying the employee</b>
            </li>
            <li><b>DID of the employee to enable authentication</b>
            </li>
            <li><b>Claims identifying the legal representative</b>
            </li>
            <li><b>The roles and duties of the LEAR</b>
            </li>
            <li><b>Advanced/Qualified signature of the credential</b>
            </li>
        </ul>
        <p>These concepts are elaborated in the following sections.
        </p>
        <section><h2>Claims identifying the employee</h2>

            <p>These are claims identifying the subject of the credential, the person who will act as LEAR. Each ecosystem can define their own depending on their specific requirements.
            </p>
            <p>In addition, each organisation can specify their own for enabling access to its products/services. However, it is recommended to use a set of claims that are agreed upon by all participants in the ecosystem unless there are specific requirements for not doing so. This includes not only the amount of claims but also their syntax and semantics.
            </p>
            <p>For our example, we use the same that are used for accessing the European Commission portal. The claims in the credential are the digital equivalent of their analog counterparts, displayed here for illustration.
            </p>
            <figure id='lear-appointment-letter-1'>
                <p><img src="images/lear-appointment-letter-1.png" alt="" />
                </p>
                <figcaption>LEAR subject identification data.
                </figcaption>
            </figure>
            <p>From the above form we can derive the following claims using the example data:
            </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
{
    <span style="color:#000080">&#34;title&#34;</span>: <span style="color:#d14">&#34;Mr.&#34;</span>,
    <span style="color:#000080">&#34;first_name&#34;</span>: <span style="color:#d14">&#34;John&#34;</span>,
    <span style="color:#000080">&#34;last_name&#34;</span>: <span style="color:#d14">&#34;Doe&#34;</span>,
    <span style="color:#000080">&#34;gender&#34;</span>: <span style="color:#d14">&#34;M&#34;</span>,
    <span style="color:#000080">&#34;postal_address&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
    <span style="color:#000080">&#34;email&#34;</span>: <span style="color:#d14">&#34;johndoe@goodair.com&#34;</span>,
    <span style="color:#000080">&#34;telephone&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
    <span style="color:#000080">&#34;fax&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
    <span style="color:#000080">&#34;mobile_phone&#34;</span>: <span style="color:#d14">&#34;+34787426623&#34;</span>
}
</pre></td></tr></table>

        </section>
        <section><h2>DID of the employee</h2>

            <p>In this example we use the <code>did:key</code> method for the DID of the employee, which provides a very high level of privacy and given the way the LEARCredential is generated it supports the verification of the chain of responsibility with a proper level of guarantee.
            </p>
            <p>If the highest levels of assurance and legal compliance is desired and the employee has an eIDAS certificate for signatures (in this case a personal one, not one like the COO), we could use the <code>elsi:did</code> method for identification of the employee. However, the organisation (GoodAir in our example) should make sure that the employee is aware of and agree to the possible privacy implications of doing so, given the personal details leaked from the eIDAS certificate.
            </p>
            <p>Those personal details are exactly the same as if the employee signs any document with a digital certificate, but care should be taken by the organisation because in this case the signature would be done "on behalf of" his employer and not as an individual personal action.
            </p>
            <p>Even though this is not unique to the <code>did:elsi</code> method, this also implies that the onboarding service has to handle those personal details in the same way as if it would be accepting any other document signed with a certificate for signatures, and ensure compliance with GDPR. This is "business as usual" when using digital signatures, but we want to make sure that this is taken care of when implementing the authentication and access control mechanisms described here.
            </p>
            <p>In this example we assume the usage of the <code>did:key</code> method for the employee to protect his privacy as much as possible.
            </p>
            <p>This DID for the employee is an additional claim to the ones presented above, using the <code>id</code> field in the <code>credentialSubject</code> object.
            </p>
            <p>Using this DID method has an additional advantage: the DID identifier corresponds to a keypair that is generated during the LEARCredential issuance process, where the private key is generated by the wallet of the employee and it is always under his control.
            </p>
            <p>This private key controlled by the employee can be used to sign challenges from Relying Parties that receive the credential to prove that the person sending the credential is the same person that is identified in the <code>credentialSubject</code> object of the LEARCredential.
            </p>
            <p>It is this property that makes this credential a VerifiableID that can be used for online authentication.
            </p>
            <p>An example DID for the employee could be:
            </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
{
    <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK&#34;</span>
}
</pre></td></tr></table>

            <p>In this example, the signatures performed with the private key can not be JAdES-compliant ([[ETSI-JADES]]), but if the LEARCredential is attached to any other credential that is signed with this private key, then they can be traced up to the eIDAS certificate of the COO and so the chain of responsibility can be determined..
            </p>
            <p>With the DID for the employee, the set of claims identifying him would be then:
            </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
{
    <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK&#34;</span>,
    <span style="color:#000080">&#34;title&#34;</span>: <span style="color:#d14">&#34;Mr.&#34;</span>,
    <span style="color:#000080">&#34;first_name&#34;</span>: <span style="color:#d14">&#34;John&#34;</span>,
    <span style="color:#000080">&#34;last_name&#34;</span>: <span style="color:#d14">&#34;Doe&#34;</span>,
    <span style="color:#000080">&#34;gender&#34;</span>: <span style="color:#d14">&#34;M&#34;</span>,
    <span style="color:#000080">&#34;postal_address&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
    <span style="color:#000080">&#34;email&#34;</span>: <span style="color:#d14">&#34;johndoe@goodair.com&#34;</span>,
    <span style="color:#000080">&#34;telephone&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
    <span style="color:#000080">&#34;fax&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
    <span style="color:#000080">&#34;mobile_phone&#34;</span>: <span style="color:#d14">&#34;+34787426623&#34;</span>
}
</pre></td></tr></table>

        </section>
        <section><h2><code>legalRepresentative</code></h2>

            <p>This section identifies the natural person (the COO) who is a legal representative of the legal person (GoodAir) and that is nominating the employee identified in the credential.
            </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#d14">&#34;legalRepresentative&#34;</span><span style="color:#a61717;background-color:#e3d2d2">:</span> {
    <span style="color:#000080">&#34;cn&#34;</span>: <span style="color:#d14">&#34;56565656V Jesus Ruiz&#34;</span>,
    <span style="color:#000080">&#34;serialNumber&#34;</span>: <span style="color:#d14">&#34;56565656V&#34;</span>,
    <span style="color:#000080">&#34;organizationIdentifier&#34;</span>: <span style="color:#d14">&#34;VATES-12345678&#34;</span>,
    <span style="color:#000080">&#34;o&#34;</span>: <span style="color:#d14">&#34;GoodAir&#34;</span>,
    <span style="color:#000080">&#34;c&#34;</span>: <span style="color:#d14">&#34;ES&#34;</span>
}
</pre></td></tr></table>

            <table style='width:100%;'><tr><td class='xnotet'><aside class='xnotea'><p class='xnotep'>NOTE: Attributes for natural and legal persons</p>
                <p>The attributes for natural persons and legal persons are derived from the <a href="https://ec.europa.eu/digital-building-blocks/wikis/download/attachments/467109280/eidas_saml_attribute_profile_v1.0_2.pdf?version=1&modificationDate=1639417533738&api=v2">eIDAS SAML Attribute Profile (eIDAS Technical Sub-group, 22 June 2015)</a>.
                </p>
                <p>All attributes for the eIDAS minimum data sets can be derived from the <a href="https://ec.europa.eu/isa2/solutions/core-vocabularies_en/">ISA Core Vocabulary</a> and <a href="https://joinup.ec.europa.eu/collection/semic-support-centre/specifications">https://joinup.ec.europa.eu/collection/semic-support-centre/specifications</a>.
                </p>
                <p>In the case of natural persons refer to the <a href="https://joinup.ec.europa.eu/asset/core_person/asset_release/core-person-vocabulary">Core Person Vocabulary</a> and in the case of legal persons refer to definitions for <a href="https://joinup.ec.europa.eu/asset/core_business/asset_release/core-business-vocabulary">Core Business Vocabulary</a>.
                </p>
            </aside></td></tr></table>
        </section>
        <section><h2><code>rolesAndDuties</code> of the LEAR</h2>

            <p>The LEARCredential should include a formal description with the roles and duties of the LEAR. This is the digital equivalent to the analog description in our example, which uses natural language:
            </p>
            <figure id='lear-appointment-letter-2'>
                <p><img src="images/lear-appointment-letter-2.png" alt="" />
                </p>
                <figcaption>LEAR roles and duties.
                </figcaption>
            </figure>
            <table style='width:100%;'><tr><td class='xnotet'><aside class='xnotea'>

                <p>We do not yet have defined the actual mechanism that will be used for describing formally the roles and duties of the LEAR. The way we specify them below is just an example. There is work ongoing to define the detailed mechanism formally (e.g. with ODRL), and it is expected to change. This example is intended only to describe the concepts in detail.
                </p>
            </aside></td></tr></table>
            <p>The <code>rolesAndDuties</code> object points to an externally hosted object with the roles and duties of the LEAR. This external object can be either a machine-interpretable definition of the roles and duties in the credential, or just an external definition of the roles and duties in natural language. The ideal approach is the first option, expressing the semantics with a proper machine-readable language, because this will allow automatic access control at the granularity of the individual sentences of that expression language. The <code>rolesAndDuties</code> object can also have the definition embedded into it, instead of having a pointer to an external object.
            </p>
            <p>A simplistic implementation of the object inside the credential could be:
            </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#d14">&#34;rolesAndDuties&#34;</span><span style="color:#a61717;background-color:#e3d2d2">:</span> [
    {
        <span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;LEARCredential&#34;</span>,
        <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;https://dome-marketplace.eu//lear/v1/6484994n4r9e990494&#34;</span>
    }
]
</pre></td></tr></table>

            <p>Where the last part of the url can correspond to the hash of the external linked document to ensure that any modification or tampering can be detected. The contents of that object ata that url could be:
            </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
[
    {
        <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;https://dome-marketplace.eu//lear/v1/6484994n4r9e990494&#34;</span>,
        <span style="color:#000080">&#34;target&#34;</span>:<span style="color:#d14">&#34;https://bae.dome-marketplace.eu/&#34;</span>
        <span style="color:#d14">&#34;roleNames&#34;</span>: [<span style="color:#d14">&#34;seller&#34;</span>, <span style="color:#d14">&#34;customer&#34;</span>]
    }
]
</pre></td></tr></table>

            <p>In the above example, we have specified that the roles object referenced in the credential with <code>id: https://dome-marketplace.eu//lear/v1/6484994n4r9e990494</code> is granting the employee of GoodAir (in our example) to access services in the DOME marketplace (specified with the field <code>target</code>) with the roles <code>seller</code> and <code>customer</code> (which are the roles of the <a href="https://business-api-ecosystem.readthedocs.io/en/latest/index.html">FIWARE BAE component</a>).
            </p>
            <p>If <code>target</code> is omitted, the roles would apply to any target organisation. If we need to specify more than one target organisation, the array should include as many objects as required.
            </p>
        </section>
        <section><h2>Assembling the pieces together</h2>

            <p>With the above values for the example, the complete LEARCredential would become something like this:
            </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
{
    <span style="color:#000080">&#34;@context&#34;</span>: [
        <span style="color:#d14">&#34;https://www.w3.org/2018/credentials/v1&#34;</span>,
        <span style="color:#d14">&#34;https://dome-marketplace.eu//2022/credentials/learcredential/v1&#34;</span>
    ],
    <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;urn:did:elsi:25159389-8dd17b796ac0&#34;</span>,
    <span style="color:#000080">&#34;type&#34;</span>: [<span style="color:#d14">&#34;VerifiableCredential&#34;</span>, <span style="color:#d14">&#34;LEARCredential&#34;</span>],
    <span style="color:#000080">&#34;issuer&#34;</span>: {
        <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;did:elsi:VATES-12345678&#34;</span>
    },
    <span style="color:#000080">&#34;issuanceDate&#34;</span>: <span style="color:#d14">&#34;2022-03-22T14:00:00Z&#34;</span>,
    <span style="color:#000080">&#34;validFrom&#34;</span>: <span style="color:#d14">&#34;2022-03-22T14:00:00Z&#34;</span>,
    <span style="color:#000080">&#34;expirationDate&#34;</span>: <span style="color:#d14">&#34;2023-03-22T14:00:00Z&#34;</span>,
    <span style="color:#000080">&#34;credentialSubject&#34;</span>: {
        <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK&#34;</span>,
        <span style="color:#000080">&#34;title&#34;</span>: <span style="color:#d14">&#34;Mr.&#34;</span>,
        <span style="color:#000080">&#34;first_name&#34;</span>: <span style="color:#d14">&#34;John&#34;</span>,
        <span style="color:#000080">&#34;last_name&#34;</span>: <span style="color:#d14">&#34;Doe&#34;</span>,
        <span style="color:#000080">&#34;gender&#34;</span>: <span style="color:#d14">&#34;M&#34;</span>,
        <span style="color:#000080">&#34;postal_address&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
        <span style="color:#000080">&#34;email&#34;</span>: <span style="color:#d14">&#34;johndoe@goodair.com&#34;</span>,
        <span style="color:#000080">&#34;telephone&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
        <span style="color:#000080">&#34;fax&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
        <span style="color:#000080">&#34;mobile_phone&#34;</span>: <span style="color:#d14">&#34;+34787426623&#34;</span>,
        <span style="color:#000080">&#34;legalRepresentative&#34;</span>: {
            <span style="color:#000080">&#34;cn&#34;</span>: <span style="color:#d14">&#34;56565656V Jesus Ruiz&#34;</span>,
            <span style="color:#000080">&#34;serialNumber&#34;</span>: <span style="color:#d14">&#34;56565656V&#34;</span>,
            <span style="color:#000080">&#34;organizationIdentifier&#34;</span>: <span style="color:#d14">&#34;VATES-12345678&#34;</span>,
            <span style="color:#000080">&#34;o&#34;</span>: <span style="color:#d14">&#34;GoodAir&#34;</span>,
            <span style="color:#000080">&#34;c&#34;</span>: <span style="color:#d14">&#34;ES&#34;</span>
        },
        <span style="color:#000080">&#34;rolesAndDuties&#34;</span>: [
            {
                <span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;LEARCredential&#34;</span>,
                <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;https://dome-marketplace.eu//lear/v1/6484994n4r9e990494&#34;</span>
            }
        ]
    }
}
</pre></td></tr></table>

        </section>
    </section>
    <section><h2>Issuing the LEARCredential</h2>

        <section><h2>Overview</h2>

            <p>In this example we use what we call a <i>profile</i> of the [[OpenID.VCI]] protocol. The standard is very flexible, and we restrict the different options available in the standard and implement a set of the options with given values that are adequate for our use case, without impacting flexibility in practice.
            </p>
            <p>The following figure describes the main components that interact in the issuance of a credential in this profile.
            </p>
            <p>The description of the issuance process is general enough to be used for many types of credentials, but the text includes notes describing the concrete application of the process to the case of the LEARCredential.
            </p>
            <figure id='iss-overview'>
                <p><img src="images/issuance/issuance_background.svg" alt="" />
                </p>
                <figcaption>Overview of participants.
                </figcaption>
            </figure>
            <p><b>End user</b>
            </p>
            <p>This profile is valid for both natural and juridical persons, but because we are focusing on the issuance of the LEARCredential, in the detailed examples below we assume a natural person as the user.
            </p>
            <p><b>Wallet</b>
            </p>
            <p>The wallet is assumed to be a Web application with a wallet backend, maybe implemented as a PWA so it has some offline capabilities and can be installed in the device, providing a user experience similar to a native application. Private key management and most sensitive operations are performed in a backend server, operated by an entity trusted by the end user. Other profiles can support native and completely offline PWA mobile applications, for end users.
            </p>
            <p>This type of wallet supports natural persons, juridical persons and natural persons who are legal entity representatives of juridical persons. For juridical persons the wallet is usually called an <code>enterprise wallet</code> but we will use here just the term <code>wallet</code> unless the distinction is required.
            </p>
            <p>In this profile we assume that the wallet is not previously registered with the Issuer and that the wallet does not expose public endpoints that are called by the Issuer, even if the wallet has a backend server that could implement those endpoints. That makes the wallet implementations in this profile to be very similar in interactions to a full mobile implementation, making migration to a full mobile implementation easier.
            </p>
            <p>In other words, from the point of view of the Issuer, the wallet in this profile is almost indistinguishable from a full mobile wallet.
            </p>
            <p><b>User Laptop</b>
            </p>
            <p>For clarity of exposition, we assume in this profile that the End User starts the interactions with the Issuer with an internet browser (user agent) in her laptop. However, there is nothing in the interactions which limits those interactions to a laptop form factor and the End User can interact with any internet browser in any device (mobile, tablet, kiosk).
            </p>
            <p><b>Issuer</b>
            </p>
            <p>In this profile we assume that the Issuer is composed of two components:
            </p>
            <ul>
                <li><b>Authorization server</b>: the backend component implementing the existing authentication/authorization functionalities for the Issuer entity.
                </li>
                <li><b>Issuer backend</b>: the main server implementing the business logic as a web application and additional backend APIs required for issuance of credentials.
                </li>
            </ul>
            <p>The Issuer backend and the Authorization server could be implemented as a single component in an actual deployment, but we assume here that they are separated to make the profile more general, especially for big entities and also when using Trust Service Providers for cloud signature and credential issuance, for example.
            </p>
            <p><b>Authentication of End User and previous Issuer-End User relationship</b>
            </p>
            <p>We assume that the Issuer and End User have a previous relationship and that the Issuer has performed the KYC required by regulation and needed to be able to issue Verifiable Credentials attesting some attributes about the End User. We assume that there is an existing trusted authentication mechanism (not necessarily related to Verifiable Credentials) that the End User employs to access protected resources from the Issuer. For example, the user is an employee or a customer of the Issuer, or the Issuer is a Local Administration and the End User is a citizen living in that city.
            </p>
        </section>
        <section><h2>Authentication</h2>

            <figure id='iss-authentication'>
                <p><img src="images/issuance/issuance_authentication.svg" alt="" />
                </p>
                <figcaption>Issuance authentication.
                </figcaption>
            </figure>
            <p>Before requesting a new credential, the End User has to authenticate with the Issuer with whatever mechanism is already implemented by the Issuer. This profile does not require that it is based on OIDC, Verifiable Credentials or any other specific mechanism.
            </p>
            <p>The level of assurance (LoA) of this authentication mechanism is one of the factors that will determine the confidence that the Verifiers can have on the credentials received by them from a given Issuer.
            </p>
            <table style='width:100%;'><tr><td class='xnotet'><aside class='xnotea'><p class='xnotep'>NOTE: LEARCredential</p>
                <p>In the case of the LEARCredential, the End User (John Doe) is an employee of GoodAir and in order to receive the credential John first has to authenticate into the company systems using whatever mechanism GoodAir uses for employee authentication.
                </p>
                <p>Being a modern company, GoodAir uses Verifiable Credentials IAM but this is not a requirement for the issuance of the LEARCredential.
                </p>
            </aside></td></tr></table>
        </section>
        <section><h2>Credential Offer</h2>

            <figure id='iss-credentialoffer'>
                <p><img src="images/issuance/issuance_credentialoffer.svg" alt="" />
                </p>
                <figcaption>Credential offer.
                </figcaption>
            </figure>
            <p>In this profile the wallet does not have to implement the Credential Offer Endpoint described in section 4 of [[OpenID.VCI]].
            </p>
            <p>Instead, the Credential Issuer renders a QR code containing a reference to the Credential Offer that can be scanned by the End-User using a Wallet, as described in section 4.1 of [[OpenID.VCI]].
            </p>
            <p>According to the spec, the Credential Offer object is a JSON object containing the Credential Offer parameters and can be sent by value or by reference. To avoid problems with the size of the QR travelling in the URL, this profile requires that the QR contains the <code>credential_offer_uri</code>, which is a URL using the <code>https</code> scheme referencing a resource containing a JSON object with the Credential Offer parameters. The <code>credential_offer_uri</code> endpoint should be implemented by the Issuer backend.
            </p>
            <section><h2>Credential Offer Parameters</h2>

                <p>This profile restricts the options available in section 4.1.1 of [[OpenID.VCI]]. The profile defines a Credential Offer object containing the following parameters:
                </p>
                <ul>
                    <li><code>credential_issuer</code>: REQUIRED. The URL of the Credential Issuer that will be used by the Wallet to obtain one or more Credentials.
                    </li>
                    <li><code>credentials</code>: REQUIRED. A JSON array, where every entry is a JSON string. To achieve interoperability faster, this profile defines a global Trusted Credential Schemas List where well-known credential schemas are defined, in addition to the individual credentials that each Issuer can define themselves. The string value MUST be one of the id values in one of the objects in the <code>credentials_supported</code> metadata parameter of the Trusted Credential Schemas List (described later), or one of the id values in one of the objects in the <code>credentials_supported</code> Credential Issuer metadata parameter provided by the Credential Issuer. When processing, the Wallet MUST resolve this string value to the respective object. The credentials defined in the global Trusted Credential Schema List have precedence over the ones defined by the Credential Issuer.
                        <div>
                        <table style='width:100%;'><tr><td class='xnotet'><aside class='xnotea'><p class='xnotep'>NOTE: LEARCredential</p>
                            <p>The only credential being offered in our case is the LEARCredential, so this is the credential schema that should be specified here. The LEARCredential is a credential known globally to the DOME ecosystem, so its schema should be published and be available in the Trusted Credential Schemas List.
                            </p>
                        </aside></td></tr></table>
                        </div>
                    </li>
                    <li><code>grants</code>: REQUIRED. A JSON object indicating to the Wallet the Grant Type <code>pre-authorized_code</code>. This grant is represented by a key and an object, where the key is <code>urn:ietf:params:oauth:grant-type:pre-authorized_code</code>. In this profile the credential issuance flow requires initial authentication of the End User by the Credential Issuer, so the Pre-Authorized Code Flow achieves a good level of security and we do not need the more general Authorization Code Flow.
                        <div>
                        <p>In other scenarios like when the wallet is a native mobile application and the user interacts with the Issuer exclusively with the mobile (without the laptop), then the Authorization Code Flow has to be used. This can be described in detail in a different profile.
                        </p>
                        </div>
                    </li>
                </ul>
                <p>The grant object contains the following values:
                </p>
                <ul>
                    <li><code>pre-authorized_code</code>: REQUIRED. The code representing the Credential Issuer's authorization for the Wallet to obtain Credentials of a certain type. This code MUST be short lived and single-use. This parameter value MUST be included in the subsequent Token Request with the Pre-Authorized Code Flow.
                    </li>
                    <li><code>user_pin_required</code>: REQUIRED. The [[OpenID.VCI]] standard says it is RECOMMENDED, but this profile specifies the user pin to achieve a greater level of security. This field is a boolean value specifying whether the Credential Issuer expects presentation of a user PIN along with the Token Request in a Pre-Authorized Code Flow. Default is false. This PIN is intended to bind the Pre-Authorized Code to a certain transaction in order to prevent replay of this code by an attacker that, for example, scanned the QR code while standing behind the legit user. It is RECOMMENDED to send a PIN via a separate channel. The PIN value MUST be sent in the <code>user_pin</code> parameter with the respective Token Request.
                    </li>
                </ul>
                <p>The following non-normative example shows a Credential Offer object where the Credential Issuer offers the issuance of one Credential ("LEARCredential"):
                </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
{
    <span style="color:#000080">&#34;credential_issuer&#34;</span>: <span style="color:#d14">&#34;https://www.goodair.com&#34;</span>,
    <span style="color:#000080">&#34;credentials&#34;</span>: [
        <span style="color:#d14">&#34;LEARCredential&#34;</span>
    ],
    <span style="color:#000080">&#34;grants&#34;</span>: {
        <span style="color:#000080">&#34;urn:ietf:params:oauth:grant-type:pre-authorized_code&#34;</span>: {
            <span style="color:#000080">&#34;pre-authorized_code&#34;</span>: <span style="color:#d14">&#34;asju68jgtyk9ikkew&#34;</span>,
            <span style="color:#000080">&#34;user_pin_required&#34;</span>: <span style="color:#000;font-weight:bold">true</span>
        }
    }
}
</pre></td></tr></table>

            </section>
            <section><h2>Contents of the QR code</h2>

                <p>Below is a non-normative example of the Credential Offer displayed by the Credential Issuer as a QR code when the Credential Offer is passed by reference, as required in this profile:
                </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#008080">https://www.goodair.com/credential-offer?</span>
<span style="color:#008080">credential_offer_uri</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">https%3A%2F%2Fserver%2Eexample%2Ecom%2Fcredential-offer%2F5j349k3e3n23j</span>
</pre></td></tr></table>

                <p>Which in plain text would be:
                </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#008080">https://www.goodair.com/credential-offer?</span>
<span style="color:#008080">credential_offer_uri</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">https://www.goodair.com/credential-offer/5j349k3e3n23j</span>
</pre></td></tr></table>

                <p>To increase security, the Issuer MUST make sure that every Credential Offer URI is unique for all credential offers created. This is the purpose of the nonce (<code>5j349k3e3n23j</code>) at the end of the url in the example. Issuers can implement whatever mechanism they wish, as far as it is transparent to the wallet.
                </p>
            </section>
        </section>
        <section><h2>Credential Issuer Metadata</h2>

            <p>The Wallet backend retrieves the Credential Issuer's configuration using the Credential Issuer Identifier that was received in the Credential Offer.
            </p>
            <p>A Credential Issuer is identified in this context by a case sensitive URL using the https scheme that contains scheme, host and, optionally, port number and path components, but no query or fragment components. No DID is used in this context.
            </p>
            <p>Credential Issuers MUST make a JSON document available at the path formed by concatenating the string <code>/.well-known/openid-credential-issuer</code> to the Credential Issuer Identifier. If the Credential Issuer value contains a path component, any terminating / MUST be removed before appending <code>/.well-known/openid-credential-issuer</code>.
            </p>
            <p><code>openid-credential-issuer</code> MUST point to a JSON document compliant with this specification and MUST be returned using the <code>application/json</code> content type.
            </p>
            <p>The retrieval of the Credential Issuer configuration is illustrated below.
            </p>
            <figure id='iss-issuermetadata'>
                <p><img src="images/issuance/issuance_issuermetadata.svg" alt="" />
                </p>
                <figcaption>Issuer metadata.
                </figcaption>
            </figure>
            <section><h2>Credential Issuer Metadata Parameters</h2>

                <p>The object contained in <code>openid-credential-issuer</code> contains the following:
                </p>
                <ul>
                    <li><code>credential_issuer</code>: REQUIRED. The Credential Issuer's identifier.
                    </li>
                    <li><code>credential_endpoint</code>: REQUIRED. URL of the Credential Issuer's Credential Endpoint. This URL MUST use the https scheme and MAY contain port, path and query parameter components.
                    </li>
                    <li><code>credentials_supported</code>: REQUIRED. A JSON array containing a list of JSON objects, each of them representing metadata about a separate credential type that the Credential Issuer can issue. The JSON objects in the array MUST conform to the structure of the Section XXXX.
                    </li>
                </ul>
                <p>TODO: define a global directory of credentials supported to eliminate requirement for each individual Issuer to publish its own list.
                </p>
                <p>This profile does not make use of the following parameters:
                </p>
                <ul>
                    <li><code>authorization_server</code> parameter, because it uses the <code>pre-authorized_code</code> Grant type.
                    </li>
                    <li><code>batch_credential_endpoint</code> parameter. It indicates that the Credential Issuer does not support the Batch Credential Endpoint.
                    </li>
                    <li><code>display</code> parameter.
                    </li>
                </ul>
            </section>
        </section>
        <section><h2>OAuth 2.0 Authorization Server Metadata</h2>

            <p>This specification also defines a new OAuth 2.0 Authorization Server metadata [[RFC8414]] parameter to publish whether the AS that the Credential Issuer relies on for authorization, supports anonymous Token Requests with the Pre-authorized Grant Type. It is defined as follows:
            </p>
            <ul>
                <li><code>pre-authorized_grant_anonymous_access_supported</code>: OPTIONAL. A JSON Boolean indicating whether the issuer accepts a Token Request with a Pre-Authorized Code but without a client id. The default is false.
                </li>
            </ul>
        </section>
        <section><h2>Access Token</h2>

            <figure id='issuance_accesstoken'>
                <p><img src="images/issuance/issuance_accesstoken.svg" alt="" />
                </p>
                <figcaption>Access Token.
                </figcaption>
            </figure>
            <p>The Wallet invokes the Token Endpoint implemented by the Authorization Server, which issues an Access Token and, optionally, a Refresh Token in exchange for the Pre-authorized Code that the wallet obtained in the Credential Offer.
            </p>
            <section><h2>Token Request</h2>

                <p>After the wallet receives the Credential Issuer Metadata, a Token Request is made as defined in Section 4.1.3 of [[RFC6749]].
                </p>
                <p>The following are the extension parameters to the Token Request used in a Pre-Authorized Code Flow as used in this profile:
                </p>
                <ul>
                    <li><code>pre-authorized_code</code>: REQUIRED. The code representing the authorization to obtain Credentials of a certain type.
                    </li>
                    <li><code>user_pin</code>: OPTIONAL. String value containing a user PIN. This value MUST be present if user_pin_required was set to true in the Credential Offer. The string value MUST consist of a maximum of 8 numeric characters (the numbers 0 - 9).
                    </li>
                </ul>
                <p>In this profile the Wallet does not have to authenticate when using the Token Endpoint, because we are using the Pre-Authorized Code Grant Type, given the level of trust between the Issuer and the End User and that authentication was already performed at the beginning of the flow.
                </p>
                <p>Below is a non-normative example of a Token Request:
                </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#900;font-weight:bold">POST</span> <span style="color:#555">/token</span> <span style="color:#000;font-weight:bold">HTTP</span><span style="color:#000;font-weight:bold">/</span><span style="color:#099">1.1</span>
Host<span style="color:#000;font-weight:bold">:</span> server.example.com
Content-Type<span style="color:#000;font-weight:bold">:</span> application/x-www-form-urlencoded

grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Apre-authorized_code
&amp;pre-authorized_code=SplxlOBeZQQYbYS6WxSbIA
&amp;user_pin=493536
</pre></td></tr></table>

            </section>
            <section><h2>Successful Token Response</h2>

                <p>Token Responses are made as defined in [[RFC6749]].
                </p>
                <p>In addition to the response parameters defined in [[RFC6749]], the Authorization Server returns the following parameters:
                </p>
                <ul>
                    <li><code>c_nonce</code>: REQUIRED. JSON string containing a nonce to be used to create a proof of possession of key material when requesting a Credential. The Wallet MUST use this nonce value for its subsequent credential requests until the Credential Issuer provides a fresh nonce.
                    </li>
                    <li><code>c_nonce_expires_in</code>: REQUIRED. JSON integer denoting the lifetime in seconds of the c_nonce.
                    </li>
                </ul>
                <p>Below is a non-normative example of a Token Response:
                </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#000;font-weight:bold">HTTP</span><span style="color:#000;font-weight:bold">/</span><span style="color:#099">1.1</span> <span style="color:#099">200</span> <span style="color:#900;font-weight:bold">OK</span>
Content-Type<span style="color:#000;font-weight:bold">:</span> application/json
Cache-Control<span style="color:#000;font-weight:bold">:</span> no-store

{
    <span style="color:#000080">&#34;access_token&#34;</span>: <span style="color:#d14">&#34;eyJhbGciOiJSUzI1NiIsInR5cCI6Ikp..sHQ&#34;</span>,
    <span style="color:#000080">&#34;token_type&#34;</span>: <span style="color:#d14">&#34;bearer&#34;</span>,
    <span style="color:#000080">&#34;expires_in&#34;</span>: <span style="color:#099">86400</span>,
    <span style="color:#000080">&#34;c_nonce&#34;</span>: <span style="color:#d14">&#34;tZignsnFbp&#34;</span>,
    <span style="color:#000080">&#34;c_nonce_expires_in&#34;</span>: <span style="color:#099">86400</span>
}
</pre></td></tr></table>

            </section>
            <section><h2>Token Error Response</h2>

                <p>If the Token Request is invalid or unauthorised, the Authorization Server constructs the error response as defined in section 6.3 of [[OpenID.VCI]].
                </p>
            </section>
        </section>
        <section><h2>Request and receive Credential</h2>

            <figure id='issuance_requestcredential'>
                <p><img src="images/issuance/issuance_requestcredential.svg" alt="" />
                </p>
                <figcaption>Request and receive Credential.
                </figcaption>
            </figure>
            <p>The Wallet backend invokes the Credential Endpoint, which issues a Credential as approved by the End-User upon presentation of a valid Access Token representing this approval.
            </p>
            <p>Communication with the Credential Endpoint MUST utilise TLS.
            </p>
            <p>The client can request issuance of a Credential of a certain type multiple times, e.g., to associate the Credential with different public keys/Decentralised Identifiers (DIDs) or to refresh a certain Credential.
            </p>
            <p>If the Access Token is valid for requesting issuance of multiple Credentials, it is at the client's discretion to decide the order in which to request issuance of multiple Credentials requested in the Authorization Request.
            </p>
            <section><h2>Binding the Issued Credential to the identifier of the End-User possessing that Credential</h2>

                <p>The Issued Credential MUST be cryptographically bound to the identifier of the End-User who possesses the Credential. Cryptographic binding allows the Verifier to verify during the presentation of a Credential that the End-User presenting a Credential is the same End-User to whom that Credential was issued.
                </p>
                <p>The Wallet has to provide proof of control alongside key material using the mechanism described below.
                </p>
            </section>
            <section><h2>Credential Request</h2>

                <p>The Wallet backend makes a Credential Request to the Credential Endpoint by sending the following parameters in the entity-body of an HTTP POST request using the <code>application/json</code> media type.
                </p>
                <ul>
                    <li><code>format</code>: REQUIRED. This profile uses the Credential format identifier <code>jwt_vc_json</code>.
                    </li>
                    <li><code>proof</code>: OPTIONAL. JSON object containing proof of possession of the key material the issued Credential shall be bound to. The specification envisions use of different types of proofs for different cryptographic schemes. The proof object MUST contain a <code>proof_type</code> claim of type JSON string denoting the concrete proof type. This type determines the further claims in the proof object and its respective processing rules. Proof types are defined in Section [[[#proof_type]]].
                    </li>
                </ul>
                <p>The proof element MUST incorporate a <code>c_nonce</code> value generated by the Credential Issuer and the Credential Issuer Identifier (audience) to allow the Credential Issuer to detect replay. The way that data is incorporated depends on the proof type. In a JWT, for example, the <code>c_nonce</code> is conveyed in the <code>nonce</code> claim whereas the audience is conveyed in the <code>aud</code> claim. In a Linked Data proof, for example, the <code>c_nonce</code> is included as the challenge element in the proof object and the Credential Issuer (the intended audience) is included as the domain element.
                </p>
                <section id='proof_type'><h2>Proof Type</h2>

                    <p>This specification defines only one value for <code>proof_type</code>:
                    </p>
                    <p><code>jwt</code>: objects of this type contain a single jwt element with a JWS [[RFC7515]] as proof of possession. The JWT MUST contain the following elements:
                        <ul>
                            <li>in the JOSE Header,
                                <div>
                                <ul>
                                    <li><code>typ</code>: REQUIRED. MUST be <code>openid4vci-proof+jwt</code>, which explicitly types the proof JWT as recommended in Section 3.11 of [[RFC8725]].
                                    </li>
                                    <li><code>alg</code>: REQUIRED. A digital signature algorithm identifier such as per IANA "JSON Web Signature and Encryption Algorithms" registry. MUST NOT be none or an identifier for a symmetric algorithm (MAC).
                                    </li>
                                    <li><code>kid</code>: REQUIRED. JOSE Header containing the key ID. The Credential will be bound to a DID, so the kid refers to a DID URL which identifies a particular key in the DID Document that the Credential will be bound to.
                                    </li>
                                </ul>
                                </div>
                            </li>
                            <li>in the JWT body,
                                <div>
                                <ul>
                                    <li><code>aud</code>: REQUIRED (string). The value of this claim MUST be the Credential Issuer URL of the Credential Issuer.
                                    </li>
                                    <li><code>iat</code>: REQUIRED (number). The value of this claim MUST be the time at which the proof was issued using the syntax defined in [[RFC7519]].
                                    </li>
                                    <li><code>nonce</code>: REQUIRED (string). The value type of this claim MUST be a string, where the value is the <code>c_nonce</code> provided by the Credential Issuer.
                                    </li>
                                </ul>
                                </div>
                            </li>
                        </ul>
                    </p>
                    <p>The Credential Issuer MUST validate that the proof is actually signed by a key identified in the JOSE Header.
                    </p>
                    <p>Below is a non-normative example of a proof parameter (dots in the middle of jwt for display purposes only), for the example of issuing a LEARCredential:
                    </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
{
    <span style="color:#000080">&#34;proof_type&#34;</span>: <span style="color:#d14">&#34;jwt&#34;</span>,
    <span style="color:#000080">&#34;jwt&#34;</span>: <span style="color:#d14">&#34;eyJraWQiOiJkaWQ6ZXhhb....aZKPxgihac0aW9EkL1nOzM&#34;</span>
}
</pre></td></tr></table>

                    <p>where the JWT looks like this:
                    </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
{
    <span style="color:#000080">&#34;typ&#34;</span>: <span style="color:#d14">&#34;openid4vci-proof+jwt&#34;</span>,
    <span style="color:#000080">&#34;alg&#34;</span>: <span style="color:#d14">&#34;ES256&#34;</span>,
    <span style="color:#000080">&#34;kid&#34;</span>:<span style="color:#d14">&#34;did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK&#34;</span>
}

{
    <span style="color:#000080">&#34;iss&#34;</span>: <span style="color:#d14">&#34;s6BhdRkqt3&#34;</span>,
    <span style="color:#000080">&#34;aud&#34;</span>: <span style="color:#d14">&#34;https://www.goodair.com&#34;</span>,
    <span style="color:#000080">&#34;iat&#34;</span>: <span style="color:#099">1659145924</span>,
    <span style="color:#000080">&#34;nonce&#34;</span>: <span style="color:#d14">&#34;tZignsnFbp&#34;</span>
}
</pre></td></tr></table>

                    <p>In the example of a LEARCredential, the wallet generates a pair of public/private keys and a <code>did:key</code> identifier which is univocally related to the public key. This is the reason why the <code>kid</code> field above is exactly the DID identifier under this DID method. The <code>did:key</code> method is very simple and achieves a very high degree of privacy, allowing the creation of many different identifiers which can be one-use only if so desired.
                    </p>
                    <p>The <code>did:key</code> method is perfect for the requirements of our usage of the LEARCredential. Any other suitable DID method can be used if it is required, but this is out of scope for this profile.
                    </p>
                </section>
            </section>
            <section><h2>Credential Response</h2>

                <p>This profile restricts Credential Response to be Synchronous and Deferred response is not used. The Credential Issuer MUST be able to immediately issue a requested Credential and send it to the Client.
                </p>
                <p>The following claims are used in the Credential Response:
                </p>
                <ul>
                    <li><code>format</code>: REQUIRED. JSON string denoting the format of the issued Credential. This profile uses the format identifier <code>jwt_vc_json</code>.
                    </li>
                    <li><code>credential</code>: REQUIRED. Contains issued Credential. MUST be a JSON string.
                    </li>
                    <li><code>c_nonce</code>: OPTIONAL. JSON string containing a nonce to be used to create a proof of possession of key material when requesting a Credential. When received, the Wallet MUST use this nonce value for its subsequent credential requests until the Credential Issuer provides a fresh nonce.
                    </li>
                    <li><code>c_nonce_expires_in</code>: OPTIONAL. JSON integer denoting the lifetime in seconds of the c_nonce.
                    </li>
                </ul>
                <p>Below is a non-normative example of a Credential Response:
                </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#000;font-weight:bold">HTTP</span><span style="color:#000;font-weight:bold">/</span><span style="color:#099">1.1</span> <span style="color:#099">200</span> <span style="color:#900;font-weight:bold">OK</span>
Content-Type<span style="color:#000;font-weight:bold">:</span> application/json
Cache-Control<span style="color:#000;font-weight:bold">:</span> no-store

{
    <span style="color:#000080">&#34;format&#34;</span>: <span style="color:#d14">&#34;jwt_vc_json&#34;</span>,
    <span style="color:#000080">&#34;credential&#34;</span> : <span style="color:#d14">&#34;LUpixVCWJk0eOt4CXQe1NXK....WZwmhmn9OQp6YxX0a2L&#34;</span>,
    <span style="color:#000080">&#34;c_nonce&#34;</span>: <span style="color:#d14">&#34;fGFF7UkhLa&#34;</span>,
    <span style="color:#000080">&#34;c_nonce_expires_in&#34;</span>: <span style="color:#099">86400</span>
}
</pre></td></tr></table>

            </section>
            <section><h2>Credential Error Response</h2>

                <p>When the Credential Request is invalid or unauthorised, the Credential Issuer constructs the error response as defined in section 7.3.1 of OIDCVCI.
                </p>
            </section>
            <section><h2>Credential Issuer Provided Nonce</h2>

                <p>Upon receiving a Credential Request, the Credential Issuer MUST require the Wallet to send a proof of possession of the key material it wants a Credential to be bound to. This proof MUST incorporate a nonce generated by the Credential Issuer. The Credential Issuer will provide the client with a nonce in an error response to any Credential Request not including such a proof or including an invalid proof.
                </p>
                <p>Below is a non-normative example of a Credential Response with the Credential Issuer requesting a Wallet to provide in a subsequent Credential Request a proof that is bound to a <code>c_nonce</code>:
                </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#000;font-weight:bold">HTTP</span><span style="color:#000;font-weight:bold">/</span><span style="color:#099">1.1</span> <span style="color:#099">400</span> <span style="color:#900;font-weight:bold">Bad Request</span>
Content-Type<span style="color:#000;font-weight:bold">:</span> application/json
Cache-Control<span style="color:#000;font-weight:bold">:</span> no-store

{
    <span style="color:#000080">&#34;error&#34;</span>: <span style="color:#d14">&#34;invalid_or_missing_proof&#34;</span>,
    <span style="color:#000080">&#34;error_description&#34;</span>:
        <span style="color:#d14">&#34;Credential Issuer requires proof to be bound to a Credential Issuer provided nonce.&#34;</span>,
    <span style="color:#000080">&#34;c_nonce&#34;</span>: <span style="color:#d14">&#34;8YE9hCnyV2&#34;</span>,
    <span style="color:#000080">&#34;c_nonce_expires_in&#34;</span>: <span style="color:#099">86400</span>
}
</pre></td></tr></table>

            </section>
        </section>
    </section>
    <section><h2>Authenticating with Verifiable Credentials</h2>

        <section><h2>Overview</h2>

            <p>Authentication requires a special type of Verifiable Credential called a VerifiableID. For the examples illustrating the mechanism we will use a LEARCredential, which is at the same time a VerifiableId and a Verifiable Authorization.
            </p>
            <p>For the explanation we will use the following figure which is based on [[[NIST-AUTH]]] which describes a reference architecture with necessary functional components to achieve authentication and enforcement of the authorization policies. The authorization process depends on four layers of functionality: <b>Enforcement</b>, <b>Decision</b>, <b>Access Control Data</b>, and <b>Administration</b>.
            </p>
            <p>The diagram uses the logical concepts also used in the XACML reference architecture, but the description is agnostic to the actual policy language used in a concrete implementation.
            </p>
            <p>In this description we assume that the user is a natural person who wants to access a protected resource. However, the architecture supports machine-to-machine (M2M) interactions. The differences will be described in the description when they are relevant.
            </p>
            <figure><img src='images/login_in_DOME/authn_architecture_numbered.drawio.png'/>
            <figcaption>Architecture overview</figcaption></figure>
            <p>The high level flow is the following:
            </p>
            <ul class='plain'>
                <li id='979.1'><a href='#979.1' class='selfref'><b>1</b></a> The user sends a request to access a protected resource managed by the Relying Party.

                </li>
                <li id='981.2'><a href='#981.2' class='selfref'><b>2</b></a> Every request to a protected resource is intercepted by the PEP (Policy Enforcement Point). The PEP is normally implemented as a reverse proxy or API gateway, so all calls to protected resources entering the organisation are intercepted and forwarded only if they are accepted. If the request does not come with authentication information, there are several high level scenarios which are possible:

                    <div>
                    <ul>
                        <li>If the user is a machine using an API, the request is rejected with an error. The caller is responsible for authenticating before retrying, which can be done using the metadata about the Relying Party available at the standard OpenID endpoints.
                        </li>
                        <li>If the user is a natural person using a browser for navigating the portal of the Relying Party, the typical approach is to redirect the browser to the authentication component using an HTTP Status of 302. The redirection includes enough information so the authentication component can send back the user to the original request if the user completes authentication successfully.
                        </li>
                    </ul>
                    </div>
                    <div>
                    <p>Alternatively, the request can include authentication information which has been obtained before via an authentication process. If this is the case, the PEP goes directly into the authentication phase, described later in section <a href="#accesscontrol" class="xref">Access control with Verifiable Credentials</a>.
                    </p>
                    </div>
                </li>
                <li id='990.3'><a href='#990.3' class='selfref'><b>3</b></a> The user is redirected to the authentication component. As mentioned before, alternatively the authorization component can be accessed directly by the user before trying to access the protected resource. This would be the expected behaviour of a user who knows that authentication is required. The mechanism described here supports all possible scenarios both for natural persons and machines.

                    <div>
                    <p>An example flow with a natural person would be: The user navigates first to a general Login page in the portal of the Relying Party and authenticates. After authentication the portal presents a collection of services that the user can access. The user selects one of the services/operations and the Relying Party executes the operation if the user is authorised to do so.
                    </p>
                    </div>
                </li>
                <li id='994.4'><a href='#994.4' class='selfref'><b>4</b></a> The Verifiable Credentials verifier component of the Relying Party retrieves the credentials that are required for authentication. If the user has been redirected when trying to access a protected resource, the redirection provides information about the operation and protected resource that was trying to access, so there may be more credentials required than just a VerifiableID.

                    <div>
                    <p>If the user accessed the Login page directly, the VC Verifier component does not have information about the resource that the user intends to access, so it can request just a VerifiableID.
                    </p>
                    </div>
                </li>
                <li id='998.5'><a href='#998.5' class='selfref'><b>5</b></a> The VC Verifier component of the Relying Party and the Wallet of the user engage in a Verifiable Presentation Exchange flow, where the result is that the VC Verifier receives a VerifiableID and possibly additional Verifiable Credentials as determined in step 4.

                </li>
                <li id='1000.6'><a href='#1000.6' class='selfref'><b>6</b></a> The authorization mechanism uses the Trust Framework to query different Trusted Lists that are needed to evaluate the policy rules applicable to the request and compute a decision.

                    <div>
                    <p>The Trust Framework is composed of one or more Trusted Lists where each list is specialised in some specific domain of trust.
                    </p>
                    </div>
                    <div>
                    <p>For example, the Trust Framework contains Trusted Lists with the schema definitions used for the well-known types of Verifiable Credentials in the ecosystem. In this way, if the Verifiable Registry used for the Trust Framework is based on a Blockchain network (or several federated networks), the schemas can be published in a trusted and resilient manner reducing the risk of malicious tampering and keeping a record of the history of modifications.
                    </p>
                    </div>
                    <div>
                    <p>But the most interesting Trusted Lists in the Trust Framework are the Trusted Issuers Lists, which provide the mechanism to efficiently and securely verify that the issuer of a given credential is a Trusted Issuer of that type of credentials.
                    </p>
                    </div>
                    <div>
                    <p>It has to be noticed that even though most Trusted Issuer Lists are global (used by all participants in the ecosystem) and have essentially public information, there may be some specialised lists that are private to one or more organisations and specialised in some specific requirement.
                    </p>
                    </div>
                    <div>
                    <p>In this way, there may be some lists that are specific to the products that one organisation provides to other participants in the ecosystem. For example, there may be a Trusted Issuer List private to one organisation which is updated with the identity of a participant when that participant acquires access to some product provided by that organisation.
                    </p>
                    </div>
                    <div>
                    <p>For example, this "product-specific" Trusted Issuer List is queried when performing authorization if the related policy rules specify that the issuer of the Verifiable Credential received in the request should have acquired the product that the request is trying to access.
                    </p>
                    </div>
                    <div>
                    <p>However, as mentioned before, the set of "internal" and "external" Trusted Lists to query is not hardcoded but it depends on the specific policy rules that should be applied to the request when computing the decision to grant access or not.
                    </p>
                    </div>
                    <div>
                    <p>In this way, the system provides a great deal of flexibility on how access control is performed.
                    </p>
                    </div>
                    <div>
                    <p>For simplicity, the diagram below shows the query of the Trusted Issuer Lists as a single interaction to a single box, but the actual interactions can be very complex if required. In addition, the diagram does not specify whether the list is "private" or "global".
                    </p>
                    </div>
                </li>
            </ul>
            <p>The following sections elaborate in more detail in each of the interactions.
            </p>
        </section>
        <section><h2>Starting the OpenID for Verifiable Presentations flow</h2>

            <p>In this section we assume that the user tries to access a protected resource and that the user is not authenticated. The flow when the user is already authenticated is the same, just skipping the authentication phase (steps 1 to 6).
            </p>
            <p>The authentication process starts an OpenID for Verifiable Presentations flow combined with the Self-Issued OP v2 specification [[OpenID.SIOP2]], where the VC Verifier component of the portal plays the role of a Relying Party (RP in Open ID Connect terminology) and the wallet of the user is a Self-Issued IdP.
            </p>
            <p>In this step, the Verifier has to send an Authorization Request to the wallet. But as a Self-Issued OP may be running locally as a native application or progressive web application (PWA), the RP may not have a network-addressable endpoint to communicate directly with the OP. We have to leverage the implicit flow of OpenID Connect to communicate with such locally-running Ops, as described in [[OpenID.SIOP2]].
            </p>
            <p>We use a QR code to start the process and allow the wallet to receive the Authorization Request from the Verifier, and respond with an Authorization Response, sent to the Verifier in the body of an HTTP <code>POST</code> request.
            </p>
            <figure><img src='builtassets/plantuml_51a6d72099c0f633c0a0905d9fcd4b0b.png' alt=''>
            <figcaption>Starting the authentication phase</figcaption></figure>

<!-- ****** EXPLANATIONS **** -->

            <ul class='plain'>
                <li id='1045.1'><a href='#1045.1' class='selfref'><b>1</b></a> The user (GoodAir employee) uses his Laptop browser to access the DOME portal to perform the onboarding process.

<div>
                    <p>We assume in this scenario a cross-device interaction, that is, the user accesses the portal services with a PC browser, but authentication is performed with a mobile using Verifiable Credentials, as in typical 2-factor authentication.
                    </p>
</div>
                </li>
                <li id='1050.2'><a href='#1050.2' class='selfref'><b>2</b></a> The browser sends a request to the Packet Delivery portal server.

<div>
</div>
                </li>
                <li id='1054.3'><a href='#1054.3' class='selfref'><b>3</b></a> The portal redirects the user to the login page of the Verifier component of DOME Onboarding. The page shows a button labelled “Login with Verifiable Credentials” or something similar.

<div>
</div>
                </li>
                <li id='1057.4'><a href='#1057.4' class='selfref'><b>4</b></a> The Verifier generates a QR code, containing inside the URL of the `/authentication-requests` endpoint of the Verifier component which will be used to start the [[OpenID.VP]] process.

<div>
                    <p>A QR code is used because a Self-Issued OP may be running locally as a native application or progressive web application (PWA), the RP may not have a network-addressable endpoint to communicate directly with the OP. We have to leverage the implicit flow of OpenID Connect to communicate with such locally-running Ops, as described in [[OpenID.SIOP2]].
                    </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#008080">https://verifier.dome-marketplace.eu/authorization-requests?state</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">af0ifjsldkj</span>
</pre></td></tr></table>

</div>
                </li>
                <li id='1064.5'><a href='#1064.5' class='selfref'><b>5</b></a> The QR code is displayed in the user browser with instructions to scan it and go to the URL inside it.

<div>
                    <figure id='qr_code_authreq'>
                        <p><img src="images/qrcode-authreq.png" alt="" />
                        </p>
                        <figcaption>QR code with the example Authorization Request endpoint inside
                        </figcaption>
                    </figure>
</div>
                </li>
                <li id='1073.6'><a href='#1073.6' class='selfref'><b>6</b></a> The user scans the QR with his wallet and tells the wallet to go to the URL in the QR.

<div>
</div>
                </li>
                <li id='1078.7'><a href='#1078.7' class='selfref'><b>7</b></a> After confirmation by the user, the wallet performs a `GET /authentication-requests` to the endpoint that was inside the QR code. The reply to the GET request is an Authorization Request

<div>
</div>
                </li>
                <li id='1082.8'><a href='#1082.8' class='selfref'><b>8</b></a> The VC Verifier creates a SIOP Authentication Request. The parameters comprising a request for verifiable presentations are described in detail in the next section

<div>
</div>
                </li>
                <li id='1085.9'><a href='#1085.9' class='selfref'><b>9</b></a> The Verifier replies to the wallet with the Authorization Request

<div>
</div>
                </li>
            </ul>
        </section>
        <section><h2>Generating the Authorization Request</h2>

            <p>The Authorization Request travels in the response body of the HTTP GET request performed in the previous point, as a JWT signed by the DOME onboarding service, using the eIDAS certificate for seals that corresponds to the legal person operating the service and with the JAdES signature format.
            </p>
            <p>The parameters comprising a request for verifiable presentations are given in section 5 of [[OpenID.VP]] and in section 10.1 of [[OpenID.SIOP2]] and are reproduced here with the particularities of this use case, in particular taking into account that this is a cross-device interaction:
            </p>
            <ul>
                <li id='1096.response_type'><a href='#1096.response_type' class='selfref'><b>response_type</b></a> (REQUIRED). Must be <code>vp_token</code>. This parameter is defined in [[RFC6749]]. The possible values are determined by the response type registry established by [[RFC6749]]. The [[OpenID.VP]] specification introduces the response type <code>vp_token</code>. This response type asks the Wallet to return only a VP Token in the Authorization Response, which is what we want in our case.

                </li>
                <li id='1098.scope'><a href='#1098.scope' class='selfref'><b>scope</b></a> (REQUIRED). This parameter is defined in [[RFC6749]] which allows it to be used by verifiers to request presentation of credentials by utilizing a pre-defined scope value designating the type of credential. See section <a href="#request_scope" class="xref">Request Scope</a> for more details. We use in this instance the value <code>dome.credentials.presentation.LEARCredential</code> which means that the RP (DOME onboarding service) is asking the SIOP (user wallet) to send a credential of type <code>LEARCredential</code>.

                </li>
                <li id='1100.response_mode'><a href='#1100.response_mode' class='selfref'><b>response_mode</b></a> REQUIRED. MUST be <code>direct_post</code>. As this is a cross-device scenario, this response mode is used to instruct the Self-Issued OP to deliver the result of the authentication process to a certain endpoint using the HTTP POST method. This endpoint to which the SIOP shall deliver the authentication result is conveyed in the parameter <code>redirect_uri</code> described below.

                </li>
                <li id='1102.redirect_uri'><a href='#1102.redirect_uri' class='selfref'><b>redirect_uri</b></a> (REQUIRED). MUST be a valid RP endpoint. The Authentication Response is sent to this endpoint using <code>POST</code> and encoding <code>application/json</code>).

                </li>
                <li id='1104.client_id'><a href='#1104.client_id' class='selfref'><b>client_id</b></a> REQUIRED. MUST be the DID of the RP (DOM onboarding entity) so it can be resolved by the SIOP and checked against a Trusted List, or rejected if it does not pass validation. This provides a high level of assurance to the SIOP that the RP is really who it claims.

                </li>
                <li id='1106.client_id_scheme'><a href='#1106.client_id_scheme' class='selfref'><b>client_id_scheme</b></a> REQUIRED. MUST have the value <code>did</code>. This value indicates that the Client Identifier is a DID defined in [[DID-Core]]. The request MUST be signed with a private key associated with the DID. To obtain the corresponding private key, the Wallet MUST use DID Resolution defined by the DID method used by the Verifier. For most DID methods and since the associated DID Document may include multiple public keys, a particular public key used to sign the request in question MUST be identified by the kid in the JOSE Header. However, in our case the Verifier uses <code>did:elsi</code> and so the request MUST be signed with the eIDAS certificate according to the [[ETSI-JADES]] format, which defines the mechanism to identify the public key.

                    <div>
                    <p>All Verifier metadata other than the public key MUST be obtained from the client_metadata or the <code>client_metadata_uri parameter</code> as defined in Section 5 of [[OpenID.VP]].
                    </p>
                    </div>
                </li>
                <li id='1110.nonce'><a href='#1110.nonce' class='selfref'><b>nonce</b></a> REQUIRED. This parameter follows the definition given in [[OpenID.Core]]. It is used to securely bind the verifiable presentation(s) provided by the wallet (SIOP) to the particular transaction managed by the RP.

                </li>
                <li id='1112.state'><a href='#1112.state' class='selfref'><b>state</b></a> REQUIRED. Used by the portal component of DOM onboarding to associate the start of an authentication session with the end of that session when the RP Verifier component notifies to the portal.

                </li>
                <li id='1114.presentation_definition'><a href='#1114.presentation_definition' class='selfref'><b>presentation_definition</b></a> CONDITIONAL. A string containing a <code>presentation_definition</code> JSON object as defined in Section 4 of [[DIF.PresentationExchange]]. We do not use this parameter because <code>scope</code> already specifies the credential type.

                </li>
                <li id='1116.presentation_definition_uri'><a href='#1116.presentation_definition_uri' class='selfref'><b>presentation_definition_uri</b></a> CONDITIONAL. A string containing a URL pointing to a resource where a <code>presentation_definition</code> JSON object as defined in Section 4 of [[DIF.PresentationExchange]] can be retrieved. We do not use this parameter because <code>scope</code> already specifies the credential type.

                </li>
            </ul>
            <p>Note: A request MUST contain either a <code>presentation_definition</code> or a <code>presentation_definition_uri</code> or a single <code>scope</code> value representing a presentation definition, those three ways to request credential presentation are mutually exclusive. We use here the <code>scope</code> mechanism, which is simpler and fits our use case.
            </p>
            <p>This is an example request object using the definitions above:
            </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#008080">openid://?</span>
<span style="color:#008080">scope</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">dome.credentials.presentation.LEARCredential&amp;</span>
<span style="color:#008080">response_type</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">vp_token&amp;</span>
<span style="color:#008080">response_mode</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">direct_post&amp;</span>
<span style="color:#008080">client_id</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">did:elsi:VATFR-99999999&amp;</span>
<span style="color:#008080">redirect_uri</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">https://verifier.dome-marketplace.eu/api/authentication_response&amp;</span>
<span style="color:#008080">state</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">af0ifjsldkj&amp;</span>
<span style="color:#008080">nonce</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">n-0S6_WzA2Mj</span>
</pre></td></tr></table>

            <p>(URL encoding removed, line breaks and leading spaces added for readability).
            </p>
            <p>As mentioned above, the Authentication Request is returned to the wallet in the reply body of the GET request, as a JWT in JWS form [[RFC7515]]), signed with eIDAS certificate of the DOM onboarding legal person.
            </p>
            <p>This is an example of the unencoded contents of the payload of the JWT:
            </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
{
    <span style="color:#000080">&#34;iss&#34;</span>: <span style="color:#d14">&#34;did:elsi:VATFR-99999999&#34;</span>,   <span style="color:#998;font-style:italic">// Should correspond with the client_id in the AR
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000080">&#34;sub&#34;</span>: <span style="color:#d14">&#34;did:elsi:VATFR-99999999&#34;</span>,   <span style="color:#998;font-style:italic">// Should correspond with the client_id in the AR
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000080">&#34;aud&#34;</span>: <span style="color:#d14">&#34;https://self-issued.me/v2&#34;</span>, <span style="color:#998;font-style:italic">// As specified in section 5.5 of OIDC4VP
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000080">&#34;iat&#34;</span>: <span style="color:#099">1667194901</span>,
    <span style="color:#000080">&#34;exp&#34;</span>: <span style="color:#099">1667194961</span>,                  <span style="color:#998;font-style:italic">// To avoid replays, here it expires in 60 secs
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000080">&#34;auth_request&#34;</span>: <span style="color:#d14">&#34;openid://?scope=...&amp;amp;response_type=vp_token&amp;amp;...&#34;</span>,
}
</pre></td></tr></table>

            <p>Where the claims <code>iss</code> and <code>sub</code> MUST be the DID of the RP (in this case DOME onboarding) and MUST correspond exactly with the <code>client_id</code> parameter in the Authorization Request. The claim <code>auth_request</code> contains the Authentication Request as a string. The expiration time in claim <code>exp</code> avoids replays and can be very short because it is used by the Wallet just on reception of the Authentication Request. The expiration time should be enough for the user to review the Authorization Request, decide the credential(s) to send to the RP and instruct the Wallet to send the Authorization Reply to the RP.
            </p>
        </section>
        <section><h2>Verification of the Authorization Request</h2>

            <p>Before sending the Authentication Response, the wallet should verify that the Authorization Request is correct. The most important verifications are described here:
            </p>
            <figure><img src='builtassets/plantuml_7d3dc5e7b6f4ba49b913e048dd96c2be.png' alt=''>
            <figcaption>Starting the authentication phase</figcaption></figure>

<!-- ****** EXPLANATIONS **** -->

            <ul class='plain'>
                <li id='1172.10'><a href='#1172.10' class='selfref'><b>10</b></a> Verification of the signature. As mentioned in the previous section, the Authorization Request is received as a JWT signed by the DOME onboarding service, using the eIDAS certificate for seals that corresponds to the legal person operating the service. This allows the wallet to verify that the signature corresponds to a real-world entity.

<div>
</div>
                </li>
                <li id='1175.11'><a href='#1175.11' class='selfref'><b>11</b></a> Verification that the DID in the `client_id` field of the Authorization Request corresponds to the entity that signed the Authorization Request. This is easy in our case because we use the `did:elsi` method.

<div>
</div>
                </li>
                <li id='1178.12'><a href='#1178.12' class='selfref'><b>12</b></a> Verification that the entity identified in the `client_id` field of the Authorization Request is a trusted entity belonging to the ecosystem, by resolving the DID in the `client_id` field.

<div>
                    <p>The actual mechanism may vary depending on the DID method used and the ecosystem where the client wants to onboard.
                    </p>
                    <p>If the Relying Party is a well known entity (like the DOME onboarding service in the case of DOME), it is easy to verify that the DID corresponds to the Relying Party.
                    </p>
                    <p>In most other cases, for example when the Relying Party is a participant in the ecosystem, we assume that the ecosystem provides a Trusted Participants Registry with an API compatible with the EBSI Trusted Issuers Registry, and that the participants registry is managed in a trusted way by the onboarding service (meaning that the Wallet user trusts on the onboarding service, in the same way as all other participants).
                    </p>
                    <p>In this case, to check if the DID is a participant on the ecosystem, the wallet sends a <code>GET /api/did/v1/identifiers/{did-to-verify}</code> request to the endpoint of one of several trusted servers implementing the functionality to query the Trusted Participant Registry, where <code>{did-to-verify}</code> is the actual DID the Wallet wants to check (in our example it would be <code>did:elsi:VATFR-99999999</code>, corresponding to the RP) . The API returns a JSON document as a DID Document. The DID Document (as per W3C) contains relevant information about the entity owner of the DID. It contains its Public Key, used to verify the digital signature of the entity. It also contains the status of the entity in the ecosystem. It is extensible and can contain any public information which may be relevant for the use case. The API must be operated by a trusted entity for the Wallet user. There may be as many servers implementing the API as needed and operated by different entities. At least one of those trusted entities has to be configured in the Wallet of the user, to facilitate the use of the wallet.
                    </p>
</div>
                </li>
            </ul>
        </section>
        <section><h2>Creating and sending the Authorization Response</h2>

            <p>Once the Authorization Request has been validated, the Wallet creates an Authorization Response to be posted in the <code>redirect_uri</code> specified by teh RP in the Authorization Request. For completeness, we describe in the following figure the complete process from reception of Authorization Request until sending the Authorization Response.
            </p>
            <figure><img src='builtassets/plantuml_089aed180d78fe7872d1120fafc45855.png' alt=''>
            <figcaption>Starting the authentication phase</figcaption></figure>

<!-- ****** EXPLANATIONS **** -->

            <ul class='plain'>
                <li id='1212.13'><a href='#1212.13' class='selfref'><b>13</b></a> The wallet creates an Authorization Response to be posted in the `redirect_uri` specified by GoodAir in the Authorization Request that was sent to the wallet. The contents of the Authorization Response are described below.

<div>
                    <p>The response is constructed as defined in section 6.1 of [[OpenID.VP]]. In particular, because the Authorization Request included only <code>vp_token</code> as the <code>response_type</code>, the VP Token is provided directly in the Authorization Response and a separate <code>id_token</code> is not needed.
                    </p>
                    <p>The contents of the Authorization Response in our specific use case are:
                    </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#008080">presentation_submission</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">[see definition below]</span>
<span style="color:#008080">&amp;vp_token</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">[see definition below]</span>
</pre></td></tr></table>

                    <p>The content of the <code>presentation_submission</code> parameter in the above Authorization Response is:
                    </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
{
    <span style="color:#000080">&#34;definition_id&#34;</span>: <span style="color:#d14">&#34;OnboardingPresentationDefinition&#34;</span>,
    <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;OnboardingPresentationSubmission&#34;</span>,
    <span style="color:#000080">&#34;descriptor_map&#34;</span>: [
    {
        <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;id_credential&#34;</span>,
        <span style="color:#000080">&#34;path&#34;</span>: <span style="color:#d14">&#34;$&#34;</span>,
        <span style="color:#000080">&#34;format&#34;</span>: <span style="color:#d14">&#34;ldp_vp&#34;</span>,
        <span style="color:#000080">&#34;path_nested&#34;</span>: {
            <span style="color:#000080">&#34;format&#34;</span>: <span style="color:#d14">&#34;ldp_vc&#34;</span>,
            <span style="color:#000080">&#34;path&#34;</span>: <span style="color:#d14">&#34;$.verifiableCredential[0]&#34;</span>
        }
    }
    ]
}
</pre></td></tr></table>

                    <p>Which complies with [[DIF.PresentationExchange]] and refers to the Verifiable Presentation in the <code>vp_token</code> parameter provided in the same response. In our example, the Verifiable Presentation includes the LEARCredential that was described in the previous sections.
                    </p>
</div>
                </li>
                <li id='1244.14'><a href='#1244.14' class='selfref'><b>14</b></a> The wallet sends the Authorization Response to the endpoint received in the `redirect_uri` parameter of the Authorization Request, sending an HTTP `POST` request using the encoding `application/x-www-form-urlencoded`.

<div>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#900;font-weight:bold">POST</span> <span style="color:#555">/api/siop/authorization_response</span> <span style="color:#000;font-weight:bold">HTTP</span><span style="color:#000;font-weight:bold">/</span><span style="color:#099">1.1</span>
Host<span style="color:#000;font-weight:bold">:</span> verifier.dome-onboarding.org
Content-Type<span style="color:#000;font-weight:bold">:</span> application/x-www-form-urlencoded

presentation_submission=[see definition below]
&amp;vp_token=[see definition below]
</pre></td></tr></table>

</div>
                </li>
            </ul>
        </section>
        <section><h2>Authenticating the user with the LEARCredential</h2>

            <p>We should remember that inside the LEARCredential the <code>credentialSubject</code> object has an <code>id</code> field with value <code>did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK</code> which is the DID of the user. It was generated during the creation of the LEARCredential, and the Relying Party should trust that the credential was generated in the proper way binding cryptographically the DID with the LEARCredential, as described in a previous section. It is the same trust that should be put in the generation of any other signed document, like a contract or invoice.
            </p>
            <p>The process of verifying the Authorization Response and authenticating the user with the LEARCredential is the following:
            </p>
            <figure><img src='builtassets/plantuml_5e65e6b64889e67cad7ed8a938eee406.png' alt=''>
            <figcaption>Starting the authentication phase</figcaption></figure>

<!-- ****** EXPLANATIONS **** -->

            <ul class='plain'>
                <li id='1275.15_and_16'><a href='#1275.15_and_16' class='selfref'><b>15 and 16</b></a> The Verifier receives the Authorization Request and has to perform verifications, the standard ones being defined in [[DIF.PresentationExchange]]. In order to verify that the Verifiable Credential has been issued by a trusted entity, the Relying Party has to verify:

<div>
                    <ol>
                        <li>That the DID of the entity which is the issuer of the VC is a trusted entity.
                        </li>
                        <li>That the VC was signed by that participant.
                        </li>
                    </ol>
                    <p>Both verifications can be done by performing DID resolution, checking that the resulting DID Document contains the public key corresponding to the one specified in the Verifiable Credential, and by verifying the digital signature of the credential against that public key.
                    </p>
                    <p>In our case the LEARCredential was issued using the <code>did:elsi</code> method, so resolution is very simple and is specified in [[DID-ELSI]].
                    </p>
</div>
                </li>
                <li id='1286.17'><a href='#1286.17' class='selfref'><b>17</b></a> After verifying the credential, the Relying Party can also verify that the Verifiable Presentation including the Verifiable Credential is sent by the user and not by a malicious agent. To do so, it uses the public key associated to the `did:key` identifier `id` field inside the `credentialSubject` structure. That public key is cryptographically bound to the customer DID during the onboarding process that GoodAir performed with its employee.

<div>
</div>
                </li>
                <li id='1289.18'><a href='#1289.18' class='selfref'><b>18</b></a> The Verifier creates an Access Token for the user so it can be used later for access services provided by the Relying Party (in the case of onboarding, those services would be the ones related to the onboarding process implemented by the Onboarding portal). The Access Token is generated in JWT format and signed by the VC Verifier. The access token is intended for use as bearer token over HTTP [[RFC2616]] using Transport Layer Security (TLS) [[RFC5246]] to access protected resources, and it should use the JWT Profile profile described in [[RFC9068]].

<div>
                    <p>For our use case, the payload of the JWT access token looks like:
                    </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
{
    <span style="color:#000080">&#34;iss&#34;</span>: <span style="color:#d14">&#34;did:elsi:VATFR-99999999&#34;</span>,
    <span style="color:#000080">&#34;sub&#34;</span>: <span style="color:#d14">&#34;did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK&#34;</span>,
    <span style="color:#000080">&#34;aud&#34;</span>:   <span style="color:#d14">&#34;https://dome-marketplace.eu/onboarding&#34;</span>,
    <span style="color:#000080">&#34;exp&#34;</span>: <span style="color:#099">1639528912</span>,
    <span style="color:#000080">&#34;iat&#34;</span>: <span style="color:#099">1618354090</span>,
    <span style="color:#000080">&#34;jti&#34;</span> : <span style="color:#d14">&#34;dbe39bf3a3ba4238a513f51d6e1691c4&#34;</span>,
    <span style="color:#000080">&#34;client_id&#34;</span>: <span style="color:#d14">&#34;did:elsi:VATFR-99999999&#34;</span>,
    <span style="color:#000080">&#34;scope&#34;</span>: <span style="color:#d14">&#34;vp_token&#34;</span>,
    <span style="color:#000080">&#34;verifiableCredential&#34;</span>: [<span style="color:#d14">&#34;the VC that was received inside the Verifiable Presentation&#34;</span>]
}
</pre></td></tr></table>

                    <p>Where, according to [[RFC9068]]:
                    </p>
                    <ul>
                        <li><code>iss</code> and <code>client_id</code> have the same value because the access token has been generated by the Verifier component of the DOME onboarding service, acting as the DOME legal person.
                        </li>
                        <li><code>sub</code> identifies the user (employee of GoodAir acting as LEAR of the company) using the DID inside the Verifiable Credential received
                        </li>
                        <li><code>aud</code> identifies the RS (Resource Server) component in Packet Delivery. In this case we assume that it is internal and does not have a DID assigned, so we use the URI of the component.
                        </li>
                        <li><code>kid</code> in the header identifies the key that is used to sign the JWT and which must be configured up-front and known by the RS (Resource Server.
                        </li>
                        <li><code>scope</code> has the same value as the equivalent <code>scope</code> parameter in the initial Authorization Request.
                        </li>
                        <li><code>verifiableCredential</code> contains the Verifiable Credential that was received, specifically the value of the first element of the field <code>verifiableCredential</code> of the Verifiable Presentation.
                        </li>
                    </ul>
</div>
                </li>
                <li id='1322.19'><a href='#1322.19' class='selfref'><b>19</b></a> The Verifier sends a successful response to the POST request from the wallet. The wallet receives the response to the POST indicating the success or failure of the process. The Verifier continues processing because the web portal of Packet Delivery has to be refreshed with the services that this specific user can access, based on the information received in the Verifiable Credential and the access control policies implemented by the DOME portal.

<div>
</div>
                </li>
                <li id='1325.20'><a href='#1325.20' class='selfref'><b>20</b></a> The Verifier notifies the DOME portal to refresh the login page so it can present the services to the user. The notification includes the following:

<div>
                    <ul>
                        <li>The <code>state</code> nonce that was generated by the portal when it generated the QR code. The portal uses the <code>state</code> nonce to know what login session is being notified.
                        </li>
                        <li>The access token generated before.
                        </li>
                    </ul>
                    <p>The notification is a simple POST request with both parameters in the body:
                    </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#900;font-weight:bold">POST</span> <span style="color:#555">/api/notify</span> <span style="color:#000;font-weight:bold">HTTP</span><span style="color:#000;font-weight:bold">/</span><span style="color:#099">1.1</span>
Host<span style="color:#000;font-weight:bold">:</span> dome-marketplace.eu
Content-Type<span style="color:#000;font-weight:bold">:</span> application/x-www-form-urlencoded

access_token=[the access token]
&amp;state=af0ifjsldkj
</pre></td></tr></table>

                    <p>The portal component replies immediately and continues processing.
                    </p>
</div>
                </li>
                <li id='1345.21'><a href='#1345.21' class='selfref'><b>21</b></a> The portal of the Relying Party refreshes the screen and displays the services available to users, sending the Access Token to the browser of the user. The Access Token will be sent back by the browser to the portal whenever the user tries to access a protected resource of the portal, and so access control can be performed using the data inside the token, in the same way as with any other access token in other authentication mechanisms.

<div>
</div>
                </li>
            </ul>
        </section>
    </section>
    <section id='accesscontrol'><h2>Access control with Verifiable Credentials</h2>

        <section><h2>Overview</h2>

            <p>This section assumes that authentication has already been performed and that the Relying Party receives a request to a protected resource, with a proper access token inside the request. If the request does not come with an access token, the request is rejected immediately (or the user is redirected to the Authentication service of the Relying Party, depending on the use case).
            </p>
            <p>The Access Control mechanism described here is the same independently of whether the request comes from a user or a machine, so the M2M use case is supported without any modification. In the following description we will use the term <b>user</b> interchangeably for both the user as a natural person or the user as a machine.
            </p>
            <p>However, the assumption is that all machines have an identity (they are assigned an identifier), and that they are acting <code>on behalf of</code> a legally valid identity in the sense of eIDAS2. In other words, we require that the identities of users and machines can be cryptographically bound to the real-world identity of either a natural person or a legal person in a way that provides legal certainty to the Relying Party regarding the chain of responsibility.
            </p>
            <p>If the user is a natural person using the portal of the Relying Party, the request to the protected resource will come from the browser that the user employs to navigate the portal, and the access token will be included automatically by the browser in every request that is sent to the Relying Party, for example when the user clicks a button or fills a form.
            </p>
            <p>If the user is a server or device, it is assumed that it has obtained an access token previously as the result of an authentication process described above. The server or device is responsible for including the access token in every request that is sent to the Relying Party to access a protected resource.
            </p>
            <p>If the portal of the Relying Party is an onboarding process (eg., the portal of the DOME Onboarding service), the protected resource could be the onboarding service itself, or a service to upload additional information for a partially completed onboarding process.
            </p>
            <p>If the portal is a Marketplace and the organisation using the portal wants to offer products in it, these services could be to register the organisation as a <i>Seller</i>, or to create a Product specification and offering.
            </p>
            <p>If the portal is the Marketplace and the organisation wants to contract products in it, these services could be to register the organisation as a <i>Customer</i>, or to launch a procurement order of a product.
            </p>
            <p>The same mechanism can be used by any participant in the ecosystem, if they want to use an advanced IAM mechanism which is aligned with the EU strategy on digital identity based on Verifiable Credential and eIDAS2.
            </p>
            <p>For the explanation we will use the following figure which is based on [[[NIST-AUTH]]] which describes a reference architecture with necessary functional components to achieve enforcement the authorization policies. The authorization process depends on four layers of functionality: <b>Enforcement</b>, <b>Decision</b>, <b>Access Control Data</b>, and <b>Administration</b>.
            </p>
            <figure id='authn-reference'>
                <p><img src="images/login_in_DOME/authn_architecture_authorization.drawio.png" alt="" />
                </p>
                <figcaption>High level Authentication logical architecture
                </figcaption>
            </figure>
        </section>
        <section><h2>Determine the Authorization Policies which apply to the request</h2>

            <p>Every request to a protected resource is intercepted by the PEP (Policy Enforcement Point), and to know if the request should be authorised or not, the PEP asks to the PDP (Policy Decision Point) for a decision. The PDP needs to know what are the policy rules that should be applied to the request, and it uses the PRP (Policy Retrieval Point) to retrieve those policies.
            </p>
            <figure><img src='builtassets/plantuml_48aaffcb8cecf468dbf62950e963e714.png' alt=''>
            <figcaption>Determine the Authorization Policies</figcaption></figure>

<!-- ****** EXPLANATIONS **** -->

            <ul class='plain'>
                <li id='1397.1'><a href='#1397.1' class='selfref'><b>1</b></a> The user (natural person or machine) sends a request to access a protected resource, and the PEP (Policy Enforcement Point) component intercepts the call. The PEP is normally implemented as a reverse proxy or API gateway, so all calls to protected resources entering the organisation are intercepted and forwarded if they are accepted.

<div>
</div>
                </li>
                <li id='1400.2'><a href='#1400.2' class='selfref'><b>2</b></a> If the request is not authenticated it is rejected with an error. Depending on the use case, the error returned can contain additional information that enables the user agent to be redirected to perform authentication.

<div>
                    <p>After inspecting the request, the PEP requests a decision from the PDP passing a series of attributes. In general, the request from the PEP to the PDP consists of <b>subject</b> attributes (typically for the user who issued the request), <b>resource</b> attributes (the resource for which access is sought), <b>action</b> attributes (the operations to be performed on the resource), and <b>environment</b> attributes.
                    </p>
                    <p>Some of the above attributes are obtained by the PEP from the original request received from the user. For example, the HTTP verb (GET, POST, PUT, PATCH, DELETE) and the URL and possibly the body of the request provide action attributes. Specifically, in the case of an NGSI-LD request those attributes are formally specified in the NGSI-LD standard.
                    </p>
                    <p>The subject attributes most relevant for access control are located in the access token received with the request. In particular, the access token includes the Verifiable Credentials that were employed for authentication, and the claims in those credentials can be used to evaluate access control policies. This includes (but is not limited to) the roles object that may be included in the VerifiableID credential used for authentication.
                    </p>
                    <p>An example access token would be:
                    </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
{
    <span style="color:#000080">&#34;token_type&#34;</span>: <span style="color:#d14">&#34;Bearer&#34;</span>,
    <span style="color:#000080">&#34;expires_in&#34;</span>: <span style="color:#099">3600</span>,
    <span style="color:#000080">&#34;access_token&#34;</span>: <span style="color:#d14">&#34;ewogICJhbGciOiAiR...ERBIgogIH0KfQ&#34;</span>
}
</pre></td></tr></table>

                    <p>Decoding the <code>access_token</code> field we could see a Verifiable Presentation including the LEARCredential that the user presented when authenticating:
                    </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
{
    <span style="color:#000080">&#34;@context&#34;</span>: [
        <span style="color:#d14">&#34;https://www.w3.org/2018/credentials/v1&#34;</span>,
        <span style="color:#d14">&#34;https://dome-marketplace.eu//2022/credentials/learcredential/v1&#34;</span>
    ],
    <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;urn:did:elsi:25159389-8dd17b796ac0&#34;</span>,
    <span style="color:#000080">&#34;type&#34;</span>: [<span style="color:#d14">&#34;VerifiableCredential&#34;</span>, <span style="color:#d14">&#34;LEARCredential&#34;</span>],
    <span style="color:#000080">&#34;issuer&#34;</span>: {
        <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;did:elsi:VATES-12345678&#34;</span>
    },
    <span style="color:#000080">&#34;issuanceDate&#34;</span>: <span style="color:#d14">&#34;2022-03-22T14:00:00Z&#34;</span>,
    <span style="color:#000080">&#34;validFrom&#34;</span>: <span style="color:#d14">&#34;2022-03-22T14:00:00Z&#34;</span>,
    <span style="color:#000080">&#34;expirationDate&#34;</span>: <span style="color:#d14">&#34;2023-03-22T14:00:00Z&#34;</span>,
    <span style="color:#000080">&#34;credentialSubject&#34;</span>: {
        <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK&#34;</span>,
        <span style="color:#000080">&#34;title&#34;</span>: <span style="color:#d14">&#34;Mr.&#34;</span>,
        <span style="color:#000080">&#34;first_name&#34;</span>: <span style="color:#d14">&#34;John&#34;</span>,
        <span style="color:#000080">&#34;last_name&#34;</span>: <span style="color:#d14">&#34;Doe&#34;</span>,
        <span style="color:#000080">&#34;gender&#34;</span>: <span style="color:#d14">&#34;M&#34;</span>,
        <span style="color:#000080">&#34;postal_address&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
        <span style="color:#000080">&#34;email&#34;</span>: <span style="color:#d14">&#34;johndoe@goodair.com&#34;</span>,
        <span style="color:#000080">&#34;telephone&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
        <span style="color:#000080">&#34;fax&#34;</span>: <span style="color:#d14">&#34;&#34;</span>,
        <span style="color:#000080">&#34;mobile_phone&#34;</span>: <span style="color:#d14">&#34;+34787426623&#34;</span>,
        <span style="color:#000080">&#34;legalRepresentative&#34;</span>: {
            <span style="color:#000080">&#34;cn&#34;</span>: <span style="color:#d14">&#34;56565656V Jesus Ruiz&#34;</span>,
            <span style="color:#000080">&#34;serialNumber&#34;</span>: <span style="color:#d14">&#34;56565656V&#34;</span>,
            <span style="color:#000080">&#34;organizationIdentifier&#34;</span>: <span style="color:#d14">&#34;VATES-12345678&#34;</span>,
            <span style="color:#000080">&#34;o&#34;</span>: <span style="color:#d14">&#34;GoodAir&#34;</span>,
            <span style="color:#000080">&#34;c&#34;</span>: <span style="color:#d14">&#34;ES&#34;</span>
        },
        <span style="color:#000080">&#34;rolesAndDuties&#34;</span>: [
            {
                <span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;LEARCredential&#34;</span>,
                <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;https://dome-marketplace.eu//lear/v1/6484994n4r9e990494&#34;</span>
            }
        ]
    }
}
</pre></td></tr></table>

                    <p>Environmental attributes, which depend on the availability of system sensors that can detect and report values, are somewhat different from subject and resource attributes, which are administratively created. Environmental attributes are not properties of the subject or resources, but are measurable characteristics that pertain to the operational or situational context in which access requests occur. These environmental characteristics are subject and resource independent, and may include the current time, day of the week, or threat level.
                    </p>
                    <p>The PDP computes decisions to permit or deny subject requests to perform actions on resources. In computing a decision, the PDP queries policies stored in a PRP (Policy Retrieval Point).
                    </p>
                    <p>If the attributes of the request are not sufficient for rule and policy evaluation, the PDP may need to search the PIP for additional attributes. The PIP is shown as one logical store, but in fact may comprise multiple physical stores of different types.
                    </p>
                    <p>In addition to the PIP, the PDP uses one or more Trusted Issuers Lists (to check if the issuer of the credential is included in them as a trusted issuer of that type of credential), and also the Authorization Registry (AR), which can check for finer granularity authorisation records which may be very dynamic in nature (e.g. if some resource usage by employees and machines owned by the issuer have exceeded some quota this month).
                    </p>
                    <p>The actual Trusted Issuers Lists that the PDP needs to check is determined by the policy rules retrieved from the PRP. Those policy rules also determine the additional queries performed to the PIP data stores.
                    </p>
                    <p>The set of information and data stored in the PIP and PRP comprise the access control data and collectively define the current authorization state, which the PDP will use to compute its decision.
                    </p>
</div>
                </li>
                <li id='1475.3'><a href='#1475.3' class='selfref'><b>3</b></a> The PDP asks the PRP for the policy rules applicable to this request. The policy rules may be specified using different policy languages, like ODRL, XACML or Rego. It is very difficult to make the interface between the PDP and the PRP completely transparent and independent from the concrete policy language used in an implementation. However, The PDP can be modularised in order to minimise the dependency and reduce the cost of migration to other policy language in the future.

<div>
</div>
                </li>
                <li id='1478.4'><a href='#1478.4' class='selfref'><b>4</b></a> The PDP receives the policy rules to apply for the current request.

<div>
</div>
                </li>
            </ul>
        </section>
        <section><h2>Determine which Trusted Issuer Lists should be queried</h2>

            <p>After retrieving the policies from the PRP, the PDP determines what are the attributes needed by the policy rules to perform its evaluation. Some of those attributes can be determined from the request received (e.g., claims inside the Verifiable Credential(s) in the access token). But in general, the policy rules require additional attributes that have to be retrieved from other sources.
            </p>
            <p>The two logical sources of those attributes are the PIP and the Trusted Issuers Lists in the Trust Anchor Framework.
            </p>
            <p>The concept of the PIP is the same as in the standard XACML logical architecture, essentially enabling the PDP to retrieve environmental attributes required for policy evaluation.
            </p>
            <p>In our approach using Verifiable Credentials for authentication and authorization, we use a Trust Framework to determine if the credentials received in the request are issued by authorised issuers of those credentials.
            </p>
            <p>The PDP does not have hardcoded the actual Trusted Lists to query, but they are determined dynamically from the policies retrieved from the PRP. In simple use cases there may be one or two lists to query which are the same for all requests. But the mechanism described here can cater for very complex scenarios where the lists may be different depending on the requests and also from the dynamic environmental information retrieved from the PIP.
            </p>
            <figure><img src='builtassets/plantuml_e9b5fd10a95e7efdd99361a716fd9818.png' alt=''>
            <figcaption>Determine Trusted Issuer Lists to query</figcaption></figure>

<!-- ****** EXPLANATIONS **** -->

            <ul class='plain'>
                <li id='1507.4'><a href='#1507.4' class='selfref'><b>4</b></a> The PDP receives the policy rules to apply for the current request.

<div>
</div>
                </li>
                <li id='1510.5'><a href='#1510.5' class='selfref'><b>5</b></a> The PDP performs an initial evaluation of the policy rules and if the attributes of the request are not sufficient for rule and policy evaluation, it determines the PIP stores to query, and also the set of Trusted Issuers Lists to query. The concrete Trusted Lists to query are dynamic and depend on the specific policies associated to the request.

<div>
</div>
                </li>
                <li id='1514.6'><a href='#1514.6' class='selfref'><b>6</b></a> Based on the policies and the attributes of the request, the PDP queries the PIP for additional attributes needed for the policy evaluation.

<div>
                    <p>Now that the PDP has the policy rules to apply and the attributes from the request and the ones retrieved from the PIP, the PDP can determine the actual Trusted Lists that have to be queried in order to be able to evaluate the policies.
                    </p>
</div>
                </li>
            </ul>
        </section>
        <section><h2>Query the Trusted Issuer Lists</h2>

            <p>The authorization mechanism uses the Trust Framework to query different Trusted Lists that are needed to evaluate the policy rules applicable to the request and compute a decision.
            </p>
            <p>The Trust Framework is composed of one or more Trusted Lists where each list is specialised in some specific domain of trust.
            </p>
            <p>For example, the Trust Framework contains Trusted Lists with the schema definitions used for the well-known types of Verifiable Credentials in the ecosystem. In this way, if the Verifiable Registry used for the Trust Framework is based on a Blockchain network (or several federated networks), the schemas can be published in a trusted and resilient manner reducing the risk of malicious tampering and keeping a record of the history of modifications.
            </p>
            <p>But the most interesting Trusted Lists in the Trust Framework are the Trusted Issuers Lists, which provide the mechanism to efficiently and securely verify that the issuer of a given credential is a Trusted Issuer of that type of credentials.
            </p>
            <p>It has to be noticed that even though most Trusted Issuer Lists are global (used by all participants in the ecosystem) and have essentially public information, there may be some specialised lists that are private to one or more organisations and specialised in some specific requirement.
            </p>
            <p>In this way, there may be some lists that are specific to the products that one organisation provides to other participants in the ecosystem. For example, there may be a Trusted Issuer List private to one organisation which is updated with the identity of a participant when that participant acquires access to some product provided by that organisation.
            </p>
            <p>For example, this "product-specific" Trusted Issuer List is queried when performing authorization if the related policy rules specify that the issuer of the Verifiable Credential received in the request should have acquired the product that the request is trying to access.
            </p>
            <p>However, as mentioned before, the set of "internal" and "external" Trusted Lists to query is not hardcoded but it depends on the specific policy rules that should be applied to the request when computing the decision to grant access or not.
            </p>
            <p>In this way, the system provides a great deal of flexibility on how access control is performed.
            </p>
            <p>For simplicity, the diagram below shows the query of the Trusted Issuer Lists as a single interaction to a single box, but the actual interactions can be very complex if required. In addition, the diagram does not specify whether the list is "private" or "global".
            </p>
            <figure><img src='builtassets/plantuml_4e81c481b979246d42f8eac88fc5bb50.png' alt=''>
            <figcaption>Query the Trusted Issuer Lists</figcaption></figure>

<!-- ****** EXPLANATIONS **** -->

            <ul class='plain'>
                <li id='1558.6'><a href='#1558.6' class='selfref'><b>6</b></a> Based on the policies and the attributes of the request, the PDP queries the PIP for additional attributes needed for the policy evaluation.

<div>
</div>
                </li>
                <li id='1562.7'><a href='#1562.7' class='selfref'><b>7</b></a> Based on the policies and the attributes of the request, the PDP queries one or more Trusted Issuer Lists to check that the credentials received comply with the requirements specified in the policies.

<div>
</div>
                </li>
            </ul>
        </section>
        <section><h2>Compute the decision and allow (or not) access</h2>

            <p>Once the PDP has all the attributes required for policy evaluation, it computes a decision and returns that decision to the PEP which will enforce it.
            </p>
            <figure><img src='builtassets/plantuml_be3b0ee126e5440e3c75eb214242be0d.png' alt=''>
            <figcaption>Compute the decision</figcaption></figure>

<!-- ****** EXPLANATIONS **** -->

            <ul class='plain'>
                <li id='1585.8'><a href='#1585.8' class='selfref'><b>8</b></a> The PDP performs a final evaluation of the policy rules, taking into consideration the attributes received from the PEP, the attributes received from the PIP, and the Trusted Issuers Lists queried. After the evaluation the PDP computes a decision, either to accept or to reject the request.

<div>
</div>
                </li>
                <li id='1588.9'><a href='#1588.9' class='selfref'><b>9</b></a> The PDP returns the decision to the PEP, which will enforce it.

<div>
</div>
                </li>
                <li id='1591.10'><a href='#1591.10' class='selfref'><b>10</b></a> If the decision from the PDP is to reject the request, the PEP returns an error to the user. Otherwise, it forwards the original request to the Resource for execution.

<div>
</div>
                </li>
                <li id='1594.11'><a href='#1594.11' class='selfref'><b>11</b></a> The resource executes the request and returns the result.

<div>
</div>
                </li>
                <li id='1597.12'><a href='#1597.12' class='selfref'><b>12</b></a> The PEP returns the result to the user.

<div>
</div>
                </li>
            </ul>
        </section>
        <section><h2>Summary of the authorization process</h2>

            <p>The following diagram combines all the steps in a single one to provide an overall view of the authorization process.
            </p>
            <figure><img src='builtassets/plantuml_c8e7f45dfb37b5dfb38c586a43f43ac2.png' alt=''>
            <figcaption>Summary of the Authorization process</figcaption></figure>

        </section>
    </section>
</section>
<section id='participants' class='appendix'><h2>Example scenario: Participants in the ecosystem</h2>

    <p>Here we introduce the actors of the reference use case we are going to use. The main actors are marked in yellow in the following diagram.
    </p>
    <p>RealTruth is a Trust Service Provider operating under the eIDAS Trust Framework, which issues a certificate for seals to the company GoodAir. GoodAir is a business that provides some services using an Air Quality application operated by GoodAir.
    </p>
    <p>RealTruth also provides a certificate for signatures to the COO of the GoodAir company, so the COO can use the certificate to sign documents on behalf of GoodAir (like contracts, invoices, financial reports, ...) in a way that is compliant with eIDAS.
    </p>
    <p>The COO of GoodAir will issue a verifiable credential of type LEARCredential to an employee of GoodAir, signing the credential with his certificate for signatures.
    </p>
    <figure><img src='builtassets/d2_36c71184cf20e51b32d23a987b6a6750.svg' alt=''>
    <figcaption></figcaption></figure>

    <section id='participant'><h2>GoodAir: the company that wants to perform the process</h2>

        <p>The new participant is a business providing an Air Quality Monitoring application as a service. The business is called GoodAir and it operates the application, which receives data from a set of sensors that may or may not be the property of GoodAir. The sensors must have received a certification to be able to operate and send data to the GoodAir application.
        </p>
        <p>The company is registered in the tax agency and business registry of Spain with VAT number <b>VATES-12345678</b>.
        </p>
    </section>
    <section><h2>COO (Chief Operating Officer) of GoodAir</h2>

        <p>The GoodAir company is small and the only person that can sign contracts on behalf of the company is the COO (Chief Operating Officer). The COO is a legal representative of the company and she is registered as so in the business registry of Spain.
        </p>
        <p>The COO has a certificate for electronic signatures issued by one of the TSPs in Spain enabling the COO to perform electronic qualified signatures as legal representative of GoodAir, instead of doing them manually.
        </p>
        <p>The X.509 certificate of the COO has the following contents in the <code>Subject</code> field (the example below is derived from a real certificate but with the identifiers modified to be an example):
        </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#008080">cn</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">56565656V Jesus Ruiz</span>
<span style="color:#008080">serialNumber</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">56565656V</span>
<span style="color:#008080">givenName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">Jesus</span>
<span style="color:#008080">sn</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">Ruiz</span>
<span style="color:#008080">2.5.4.97</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">VATES-12345678</span>
<span style="color:#008080">o</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">GoodAir</span>
<span style="color:#008080">c</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">ES</span>
<span style="color:#008080">2.5.4.13</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">Notary:Juan Lopez/Protocol Num:7172/Date:07-06-2021</span>
</pre></td></tr></table>

        <p>The above set of fields bind the legal identity of the COO with the identity of the business:
        </p>
        <ul>
            <li><code>serialNumber</code> is the unique number recognized by the Spanish Government for spanish citizens (called NIF).
            </li>
            <li><code>2.5.4.97</code> is the <a href="https://oidref.com/2.5.4.97">official OID for <code>organizationIdentifier</code></a>. The contents of this field in the example certificate is the unique identifier for the legal person GoodAir.
            </li>
        </ul>
        <p>Before issuing a certificate like the above, the TSP has to perform some validations to ensure that in the official source of truth (the business registry of Spain in this case) there is already registered information that states that the COO has indeed powers to act on behalf of GoodAir as a legal representative.
        </p>
    </section>
    <section><h2>RealTruth: a Trust Service Provider</h2>

        <p>RealTruth is an EU TSP, which appears in the TL (Trusted List) maintained by the <a href="https://tl.bundesnetzagentur.de/TL-DE.XML">German Government</a>.
        </p>
        <p>RealTruth is a TSP based in Germany but operates in most of the countries of the EU and so being able to provide Trust Services across many countries, including Spain.
        </p>
        <p>As all TSPs in the TLs of the Member States, its entry in the TL includes one or more "Services" entries which describe the Trust Services provided by the TSP.
        </p>
        <p>A TSP can have one Service issuing certificates for signatures, another service issuing certificates for seals, another service for timestamping, etc.
        </p>
        <p>The regulator approves or suspends each service from a TSP individually, and the services are the root anchor for a given trust environment.
        </p>
        <p>In our case, the entry for RealTruth in the TL includes a <code>&ltTSPService&gt</code> entry, and inside it the <code>&ltServiceDigitalIdentity&gt</code> entry includes a DER-encoded certificate specifying the digital identity of the root anchor for that trust domain. The certificate for the Service has in the Subject field:
        </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
<span style="color:#008080">2.5.4.97</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">VATDE-170173453</span>
<span style="color:#008080">CN</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">DRV QC 11 MA CA 2017ca</span>
<span style="color:#008080">OU</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">QC 11 Mitarbeiter CA</span>
<span style="color:#008080">O</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">Deutsche Rentenversicherung Westfalen</span>
<span style="color:#008080">C</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">DE</span>
</pre></td></tr></table>

        <p>Which in the <code>organizationIdentifier</code> field (OID 2.5.4.97) specifies the unique organisation identifier assigned by the German regulatory authority to the TSP: VATDE-170173453.
        </p>
        <p>RealTruth provides <code>Legal Person Representative Certificates</code> which are qualified in accordance with Regulation (EU) No. 910/2014 of the European Parliament and of the Council of 23 July 2014 on electronic identification and trust services for electronic transactions in the internal market.
        </p>
        <p>The certification policies of RealTruth includes the following sentences:
        </p>
        <blockquote>
            <p>The Registration Authority must verify the following information in order to authenticate the identity of the organisation:
            </p>
            <ul>
                <li>The data concerning the business name or corporate name of the organisation.
                </li>
                <li>The data relating to the constitution and legal status of the subscriber.
                </li>
                <li><b>The data concerning the extent and validity of the powers of representation of the applicant.</b>
                </li>
                <li>The data concerning the tax identification code of the organisation or equivalent code used in the country to whose legislation the subscriber is subject.
                </li>
            </ul>
        </blockquote>
        <p>The TSP (RealTruth in this case) performs the verifications against <code>Authentic Sources</code>.
        </p>
        <blockquote>
            <p>Authentic Sources are the public or private repositories or systems recognised or required by law containing attributes about a natural or legal persons.
            </p>
            <p>The Authentic Sources in scope of Annex VI of the [eIDAS2] legislative proposal are sources for attributes on address, age, gender, civil status, family composition, nationality, education and training qualifications titles and licences, professional qualifications titles and licences, public permits and licences, financial and company data.
            </p>
            <p>Authentic Sources in scope of Annex VI are required to provide interfaces to Qualified Electronic Attestation of Attributes  (QEAA) Providers to verify the authenticity of the above attributes, either directly or via designated intermediaries recognised at national level.
            </p>
            <p>Authentic Sources may also issue (Q)EAA-s themselves if they meet the requirements of the eIDAS Regulation. It is up to the Member States to define terms and conditions for the provisioning of these services, but according to the minimum technical specifications, standards, and procedures applicable to the verification procedures for qualified electronic attestations of attributes.
            </p>
        </blockquote>
        <p>In accordance to the policies, RealTruth made those validations when issuing the certificate to the COO, in such a way that the Relying Parties verifying the certificate can have a high level of trust in the assertion that the natural person identified in the certificate (with Spanish ID of 56565656V) is a legal representative of he GoodAir company (organizationIdentifier VATES-12345678).
        </p>
    </section>
    <section><h2>John Doe: an administrative employee of GoodAir</h2>

        <p>This is an employee of the central administration department of GoodAir, who is going to be formally nominated to manage a specific set of processes on behalf of GoodAir in the Data Space. In particular, this employee is going to be nominated as a LEAR (Legal Entity Appointed Representative).
        </p>
        <p>As its name implies, the LEAR has to be nominated by a <b>legal representative</b> of the GoodAir organisation with the necessary legal authority to commit the organisation for this type of decision. In our case, the COO of GoodAir will nominate John Doe as the LEAR of GoodAir, delegating to him the capabilities to perform some processes in the DOME portal and some other tasks in other organisations. That means that John Doe will not be empowered to perform cation snot explicitly specified in the credential.
        </p>
        <p>To perform the nomination, the COO of GoodAir (a legal representative of GoodAir) will issue a special credential to John Doe and will sign the credential with his certificate for signatures as legal representative of GoodAir. The details are described later in this document.
        </p>
    </section>
    <section><h2>DOME: an instance of a Data Space for Smart Cities</h2>

        <p>DOME is a Data Space where local governments can procure data and services from other entities that act as service providers. At the same time, the local governments can also act as data and service providers for other entities in the Data Space.
        </p>
        <p>The DOME Data Space has an portal service that allows external entities to perform some processes in an automated fashion by using Verifiable Credentials that have been issued by trusted entities. The complete Trust Framework used by DOME is composed from a series of Trust Frameworks, some managed internally using a governance model of DOME and some others managed externally but by trusted entities. At the root of the Trust Framework of DOME is the eIDAS Trust Framework and the pan-european recognized list of Trust Service Providers issuing the eIDAS compliant digital identities, in the form of certificates for signatures/seals.
        </p>
        <p>In order to participate in DOME, every legal person requires a certificate for seals or that one of its legal representatives has a certificate for signatures (or both). The DOME entity is registered in France with VAT number <b>VATFR-99999999</b>.
        </p>
    </section>
</section>
<section id='request_scope'><h2>Request Scope</h2>

    <p>According to section 5.3 of [[OpenID.VP]], wallets MAY support requesting presentation of credentials using OAuth 2.0 <code>scope</code> values. Such a scope value MUST be an alias for a well-defined presentation definition as it will be referred to in the <code>presentation_submission</code> response parameter.
    </p>
    <p>In this specification we define concrete scope values and the mapping between a certain scope value and the respective presentation definition, in particular the mapping between scope values and specific types of Verifiable Credentials used for access control in the use case described in this document. In a production implementation of a Data Space ecosystem, the Trust Framework has to define the mappings used in the ecosysyem and the mechanisms and governance model used to update those mappings.
    </p>
    <p>In this example we only need the mapping for the LEARCredential, where the scope <code>dome.credentials.presentation.LEARCredential</code> represents the following presentation definition:
    </p>

<table style="width:100%;"><tr><td class="codecolor">
<pre class='nohighlight precolor'>
{
    <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;dome.credentials.presentation.LEARCredential&#34;</span>,
    <span style="color:#000080">&#34;input_descriptors&#34;</span>: [
        {
        <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;LEARCredentialDefinitionv1.01&#34;</span>,
        <span style="color:#000080">&#34;format&#34;</span>: {
            <span style="color:#000080">&#34;ldp_vc&#34;</span>: {
                <span style="color:#000080">&#34;proof_type&#34;</span>: [
                    <span style="color:#d14">&#34;RsaSignature2018&#34;</span>
                ]
            }
        },
        <span style="color:#000080">&#34;constraints&#34;</span>: {
            <span style="color:#000080">&#34;fields&#34;</span>: [
                {
                    <span style="color:#000080">&#34;path&#34;</span>: [
                        <span style="color:#d14">&#34;$.type&#34;</span>
                    ],
                    <span style="color:#000080">&#34;filter&#34;</span>: {
                        <span style="color:#000080">&#34;type&#34;</span>: <span style="color:#d14">&#34;string&#34;</span>,
                        <span style="color:#000080">&#34;pattern&#34;</span>: <span style="color:#d14">&#34;LEARCredential&#34;</span>
                    }
                }
            ]
        }
        }
    ]
}
</pre></td></tr></table>

</section>
<section id='references'>
</section>


</body>
</html>
